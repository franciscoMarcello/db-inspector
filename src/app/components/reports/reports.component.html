<div class="reports-shell" [class.sidebar-collapsed]="sidebarCollapsed">
  <aside class="tree-panel" *ngIf="!sidebarCollapsed">
    <div class="tree-header">
      <div class="tree-header__row">
        <h3>Visualizador de Relatorios</h3>
        <button type="button" class="btn btn--neutral btn--icon" (click)="toggleSidebar()">
          ‚óÄ
        </button>
      </div>
      <p>{{ manageMode ? 'Gest√£o de pastas e consultas' : 'Pastas e consultas' }}</p>
    </div>

    <div class="folder-create" *ngIf="manageMode">
      <button type="button" class="btn btn--primary" (click)="openFolderManager()">
        Gerenciar pastas
      </button>
      <button type="button" class="btn btn--neutral" (click)="openTemplateManager()">
        Gerenciar templates PDF
      </button>
    </div>

    <div class="tree-list">
      <div class="tree-folder" *ngFor="let folder of folders">
        <div class="folder-row">
          <button
            type="button"
            class="folder-btn"
            [class.archived]="folder.archived"
            [class.active]="selectedFolderId === folder.id"
            (click)="selectFolder(folder)"
          >
            <span class="arrow mini" (click)="$event.stopPropagation(); toggleFolder(folder.id)">
              {{ folder.expanded ? '‚ñæ' : '‚ñ∏' }}
            </span>
            <span class="folder-name">{{ folder.name }}</span>
            <span class="archived-badge" *ngIf="folder.archived">Arquivado</span>
            <span class="folder-count">{{ reportCountByFolder(folder) }}</span>
          </button>
          <button
            *ngIf="manageMode"
            type="button"
            class="btn btn--neutral btn--icon folder-plus"
            (click)="openCreateReportForFolder(folder, $event)"
            title="Novo relat√≥rio nesta pasta"
            aria-label="Novo relat√≥rio nesta pasta"
          >
            Ôºã
          </button>
        </div>

        <div class="tree-reports" *ngIf="folder.expanded">
          <button
            type="button"
            class="report-leaf"
            *ngFor="let report of reportsByFolder(folder)"
            [class.archived]="report.archived"
            [class.active]="selectedReportId === report.id"
            (click)="selectReport(report.id)"
          >
            <span>{{ report.name }}</span>
            <span class="archived-badge archived-badge--leaf" *ngIf="report.archived">Arquivado</span>
          </button>
          <div class="tree-empty" *ngIf="reportsByFolder(folder).length === 0">Sem relat√≥rios</div>
        </div>
      </div>
    </div>
  </aside>

  <main class="content-panel">
    <section class="card filters">
      <div class="title">
        <div class="title-row">
          <h2>{{ runResult?.name || selectedReport?.name || 'Relatorio' }}</h2>
          <div class="title-actions">
            <button
              *ngIf="sidebarCollapsed"
              type="button"
              class="btn btn--show-sidebar btn--sm"
              (click)="toggleSidebar()"
            >
              ‚ñ∂ Mostrar pastas
            </button>
          </div>
        </div>
        <p>{{ selectedReport?.description || 'Selecione um relatorio na arvore.' }}</p>
      </div>

      <div class="vars-panel" *ngIf="selectedReportVariables.length">
        <div class="vars-title">Par√¢metros da consulta</div>
        <div class="vars-grid">
          <label class="var-field" *ngFor="let v of selectedReportVariables">
            <span>{{ v.label || v.key }} <em *ngIf="v.required">*</em></span>
            <ng-container *ngIf="hasVariableOptions(v); else freeInput">
              <input
                matInput
                class="var-autocomplete"
                type="text"
                placeholder="Selecione ou digite para filtrar"
                [matAutocomplete]="varAuto"
                [ngModel]="variableOptionSearchText[v.key] || ''"
                [ngModelOptions]="{ standalone: true }"
                (ngModelChange)="onVariableOptionSearchChange(v, $event)"
              />
              <mat-autocomplete
                #varAuto="matAutocomplete"
                class="report-var-options-panel"
                [displayWith]="displayVariableOption"
                (optionSelected)="onVariableOptionSelected(v, $event.option.value)"
              >
                <mat-option *ngFor="let opt of filteredVariableOptionItems(v)" [value]="opt">
                  {{ opt.descricao }}
                </mat-option>
                <mat-option *ngIf="!filteredVariableOptionItems(v).length" disabled>
                  Sem op√ß√µes
                </mat-option>
              </mat-autocomplete>
              <small class="muted" *ngIf="variableOptionsLoading(v)">Carregando op√ß√µes...</small>
            </ng-container>
            <ng-template #freeInput>
              <ng-container [ngSwitch]="v.type">
                <input
                  *ngSwitchCase="'date'"
                  type="date"
                  [(ngModel)]="variableInputs[v.key]"
                  [ngModelOptions]="{ standalone: true }"
                  (ngModelChange)="onVariableInputChanged()"
                />
                <input
                  *ngSwitchCase="'datetime'"
                  type="datetime-local"
                  [(ngModel)]="variableInputs[v.key]"
                  [ngModelOptions]="{ standalone: true }"
                  (ngModelChange)="onVariableInputChanged()"
                />
                <input
                  *ngSwitchCase="'number'"
                  type="number"
                  [(ngModel)]="variableInputs[v.key]"
                  [ngModelOptions]="{ standalone: true }"
                  (ngModelChange)="onVariableInputChanged()"
                />
                <select
                  *ngSwitchCase="'boolean'"
                  [(ngModel)]="variableInputs[v.key]"
                  [ngModelOptions]="{ standalone: true }"
                  (ngModelChange)="onVariableInputChanged()"
                >
                  <option value="">(padr√£o)</option>
                  <option value="true">true</option>
                  <option value="false">false</option>
                </select>
                <input
                  *ngSwitchDefault
                  type="text"
                  [(ngModel)]="variableInputs[v.key]"
                  [ngModelOptions]="{ standalone: true }"
                  (ngModelChange)="onVariableInputChanged()"
                />
              </ng-container>
            </ng-template>
          </label>
        </div>
      </div>

      <p class="params-error" *ngIf="paramsError">{{ paramsError }}</p>

      <div class="actions" *ngIf="manageMode">
        <button type="button" class="btn btn--primary" (click)="applyFilters()">
          <span class="btn-icon">‚ñ∂</span> Executar
        </button>
        <button type="button" class="btn btn--neutral" (click)="openCreateReportModal()">
          <span class="btn-icon">Ôºã</span> Novo relatorio
        </button>
        <button
          type="button"
          class="btn btn--edit"
          (click)="openEditReportModal()"
          [disabled]="!selectedReport"
        >
          <span class="btn-icon">‚úé</span> Editar
        </button>
        <button
          type="button"
          class="btn btn--archive"
          (click)="archiveSelectedReport()"
          [disabled]="!selectedReport || !!selectedReport.archived"
        >
          <span class="btn-icon">üóÇ</span> Arquivar
        </button>
        <button
          type="button"
          class="btn btn--neutral"
          (click)="unarchiveSelectedReport()"
          [disabled]="!selectedReport || !selectedReport.archived"
        >
          <span class="btn-icon">‚Ü∫</span> Desarquivar
        </button>
        <button
          type="button"
          class="btn btn--excel"
          (click)="exportExcel()"
          [disabled]="!hasResultRows"
        >
          <span class="btn-icon">‚§ì</span> Exportar Excel
        </button>
        <button
          *ngIf="canExportPdf"
          type="button"
          class="btn btn--pdf"
          (click)="exportPdf()"
          [disabled]="loadingPdf || !hasRequiredParamsForRun"
        >
          <mat-icon class="btn-icon btn-icon--pdf" aria-hidden="true">picture_as_pdf</mat-icon>
          {{ loadingPdf ? 'Gerando PDF...' : 'Exportar PDF' }}
        </button>
      </div>

      <div class="actions" *ngIf="!manageMode">
        <button type="button" class="btn btn--primary" (click)="applyFilters()">
          <span class="btn-icon">‚ñ∂</span> Executar
        </button>
        <button
          type="button"
          class="btn btn--excel"
          (click)="exportExcel()"
          [disabled]="!hasResultRows"
        >
          <span class="btn-icon">‚§ì</span> Exportar Excel
        </button>
        <button
          *ngIf="canExportPdf"
          type="button"
          class="btn btn--pdf"
          (click)="exportPdf()"
          [disabled]="loadingPdf || !hasRequiredParamsForRun"
        >
          <mat-icon class="btn-icon btn-icon--pdf" aria-hidden="true">picture_as_pdf</mat-icon>
          {{ loadingPdf ? 'Gerando PDF...' : 'Exportar PDF' }}
        </button>
      </div>
    </section>

    <section class="card table-card" *ngIf="runResult as result; else emptyState">
      <div class="table-meta">
        <span>Total de linhas: <strong>{{ result.meta.rowCount }}</strong></span>
        <span>Exibindo: <strong>{{ displayedRows.length }}</strong></span>
        <span *ngIf="result.meta.elapsedMs">Tempo: <strong>{{ result.meta.elapsedMs }} ms</strong></span>
      </div>
      <div class="table-wrap">
        <div class="no-results" *ngIf="displayedRows.length === 0">Sem resultado.</div>
        <table *ngIf="displayedRows.length > 0">
          <thead>
            <tr>
              <th *ngFor="let col of result.columns">{{ col }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of displayedRows">
              <td *ngFor="let col of result.columns">{{ row[col] }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<ng-template #emptyState>
  <section class="card table-card">
    <p class="muted">{{ loadingRun ? 'Executando relatorio...' : 'Nenhum resultado para exibir.' }}</p>
  </section>
</ng-template>

<section class="card status-card" *ngIf="statusMessage || runResult?.meta">
  <div class="status-line" [ngClass]="statusToneClass" *ngIf="statusMessage">
    <strong>{{ statusTitle }}</strong>
    <span>{{ statusMessage }}</span>
  </div>
  <div class="status-meta" *ngIf="runResult?.meta as meta">
    <span>Ambiente: {{ meta.environment || 'N/A' }}</span>
    <span>Gerado em: {{ meta.generatedAt || 'N/A' }}</span>
    <span>√öltima execu√ß√£o: {{ meta.lastRunAt || 'N/A' }}</span>
    <span>Linhas: {{ meta.rowCount }}</span>
    <span>Tempo: {{ meta.elapsedMs }} ms</span>
  </div>
</section>

<dialog class="report-modal" [open]="reportModalOpen">
  <div class="report-modal__panel">
    <div class="report-modal__header">
      <h3>{{ reportModalMode === 'create' ? 'Novo relat√≥rio' : 'Editar relat√≥rio' }}</h3>
      <button type="button" class="btn btn--secondary" (click)="closeReportModal()">Fechar</button>
    </div>

    <div class="report-modal__body">
      <label class="var-field">
        <span>Nome</span>
        <input
          type="text"
          [(ngModel)]="reportDraft.name"
          [ngModelOptions]="{ standalone: true }"
          placeholder="Nome do relat√≥rio"
        />
      </label>

      <label class="var-field">
        <span>Pasta</span>
        <div class="folder-picker">
          <select [(ngModel)]="reportDraft.folderId" [ngModelOptions]="{ standalone: true }">
            <option *ngFor="let folder of folders" [value]="folder.id">{{ folder.name }}</option>
          </select>
          <button type="button" class="btn btn--neutral" (click)="createFolderFromReportModal()">
            + Pasta
          </button>
        </div>
      </label>

      <label class="var-field">
        <span>Template PDF (Jasper)</span>
        <div class="template-picker">
          <select [(ngModel)]="reportDraft.jasperTemplateId" [ngModelOptions]="{ standalone: true }">
            <option value="">Sem template</option>
            <option *ngFor="let template of templates" [value]="template.id">{{ template.name }}</option>
          </select>
          <button type="button" class="btn btn--neutral" (click)="openTemplateManager()">
            Gerenciar templates
          </button>
        </div>
      </label>

      <label class="var-field">
        <span>Descri√ß√£o</span>
        <input
          type="text"
          [(ngModel)]="reportDraft.description"
          [ngModelOptions]="{ standalone: true }"
          placeholder="Descri√ß√£o (opcional)"
        />
      </label>

      <label class="var-field">
        <span>SQL</span>
        <textarea
          rows="10"
          [(ngModel)]="reportDraft.sql"
          [ngModelOptions]="{ standalone: true }"
          (input)="onDraftSqlChanged()"
          placeholder="SELECT * FROM ... WHERE data >= :data_inicio"
        ></textarea>
      </label>

      <div class="vars-panel">
        <div class="vars-title">Vari√°veis detectadas</div>
        <div class="draft-vars-empty" *ngIf="!reportDraftVariables.length">
          Nenhum placeholder :variavel detectado na SQL.
        </div>
        <div class="draft-vars-grid" *ngIf="reportDraftVariables.length">
          <div class="draft-vars-head">Usar</div>
          <div class="draft-vars-head">Key</div>
          <div class="draft-vars-head">Label</div>
          <div class="draft-vars-head">Tipo</div>
          <div class="draft-vars-head">Obrigat√≥ria</div>
          <div class="draft-vars-head">Padr√£o</div>
          <div class="draft-vars-head">SQL op√ß√µes</div>

          <ng-container *ngFor="let v of reportDraftVariables">
            <div>
              <input type="checkbox" [(ngModel)]="v.enabled" [ngModelOptions]="{ standalone: true }" />
            </div>
            <div>{{ v.key }}</div>
            <div>
              <input type="text" [(ngModel)]="v.label" [ngModelOptions]="{ standalone: true }" />
            </div>
            <div>
              <select [(ngModel)]="v.type" [ngModelOptions]="{ standalone: true }">
                <option value="string">string</option>
                <option value="number">number</option>
                <option value="date">date</option>
                <option value="datetime">datetime</option>
                <option value="boolean">boolean</option>
              </select>
            </div>
            <div>
              <input type="checkbox" [(ngModel)]="v.required" [ngModelOptions]="{ standalone: true }" />
            </div>
            <div>
              <input
                type="text"
                [(ngModel)]="v.defaultValue"
                [ngModelOptions]="{ standalone: true }"
                placeholder="opcional"
              />
            </div>
            <div>
              <textarea
                rows="2"
                [(ngModel)]="v.optionsSql"
                [ngModelOptions]="{ standalone: true }"
                placeholder="SELECT id AS valor, nome AS descricao FROM ... WHERE ..."
              ></textarea>
            </div>
          </ng-container>
        </div>
      </div>

      <p class="params-error" *ngIf="reportDraftError">{{ reportDraftError }}</p>
    </div>

    <div class="report-modal__footer">
      <button type="button" class="btn btn--primary" (click)="saveReportFromModal()">Salvar</button>
    </div>
  </div>
</dialog>

<dialog class="report-modal" [open]="folderManagerOpen">
  <div class="report-modal__panel report-modal__panel--small">
    <div class="report-modal__header">
      <h3>Gerenciar pastas</h3>
      <button type="button" class="btn btn--secondary" (click)="closeFolderManager()">Fechar</button>
    </div>

    <div class="report-modal__body folder-manager">
      <div class="folder-manager__section">
        <label class="var-field">
          <span>Nova pasta</span>
          <input
            type="text"
            [(ngModel)]="newFolderName"
            [ngModelOptions]="{ standalone: true }"
            placeholder="Nome da pasta"
            (keydown.enter)="createFolder()"
          />
        </label>
        <button type="button" class="btn btn--primary" (click)="createFolder()">Criar pasta</button>
      </div>

      <div class="folder-manager__section">
        <label class="var-field">
          <span>Pasta para gerenciar</span>
          <select
            [ngModel]="selectedFolderId || ''"
            [ngModelOptions]="{ standalone: true }"
            (ngModelChange)="onFolderManagerSelectionChange($event)"
          >
            <option value="">Selecione uma pasta</option>
            <option *ngFor="let folder of folders" [value]="folder.id">
              {{ folder.name }}{{ folder.archived ? ' (arquivada)' : '' }}
            </option>
          </select>
        </label>

        <label class="var-field">
          <span>Novo nome da pasta</span>
          <input
            type="text"
            [(ngModel)]="renameFolderName"
            [ngModelOptions]="{ standalone: true }"
            [disabled]="!selectedFolder"
            placeholder="Novo nome"
            (keydown.enter)="renameSelectedFolder()"
          />
        </label>

        <div class="actions">
          <button
            type="button"
            class="btn btn--secondary"
            (click)="renameSelectedFolder()"
            [disabled]="!selectedFolder"
          >
            Renomear
          </button>
          <button
            type="button"
            class="btn btn--archive"
            (click)="archiveSelectedFolder()"
            [disabled]="!selectedFolder || !!selectedFolder.archived"
          >
            Arquivar
          </button>
          <button
            type="button"
            class="btn btn--neutral"
            (click)="unarchiveSelectedFolder()"
            [disabled]="!selectedFolder || !selectedFolder.archived"
          >
            Desarquivar
          </button>
        </div>
      </div>
    </div>
  </div>
</dialog>

<dialog class="report-modal" [open]="templateManagerOpen">
  <div class="report-modal__panel">
    <div class="report-modal__header">
      <h3>Gerenciar templates PDF</h3>
      <button type="button" class="btn btn--secondary" (click)="closeTemplateManager()">Fechar</button>
    </div>

    <div class="report-modal__body template-manager">
      <div class="template-manager__list">
        <div class="template-manager__top">
          <button type="button" class="btn btn--neutral" (click)="startNewTemplate()">Novo</button>
        </div>
        <button
          type="button"
          class="template-item"
          *ngFor="let template of templates"
          [class.active]="template.id === selectedTemplateId"
          (click)="selectTemplate(template.id)"
        >
          {{ template.name }}
        </button>
        <p class="muted" *ngIf="!templates.length">Nenhum template cadastrado.</p>
      </div>

      <div class="template-manager__form">
        <label class="var-field">
          <span>Nome</span>
          <input
            type="text"
            [(ngModel)]="templateDraft.name"
            [ngModelOptions]="{ standalone: true }"
            placeholder="Ex.: Curral PDF"
          />
        </label>

        <label class="var-field">
          <span>Descri√ß√£o</span>
          <input
            type="text"
            [(ngModel)]="templateDraft.description"
            [ngModelOptions]="{ standalone: true }"
            placeholder="Opcional"
          />
        </label>

        <label class="var-field">
          <span>Arquivo JRXML</span>
          <div class="file-picker">
            <label class="btn btn--secondary file-picker__btn" for="template-jrxml-file">Escolher arquivo</label>
            <input
              id="template-jrxml-file"
              type="file"
              accept=".jrxml,application/xml,text/xml"
              (change)="onTemplateManagerFileSelected($event)"
            />
            <span class="file-picker__name">
              {{ templateFileName || 'Nenhum arquivo selecionado' }}
            </span>
          </div>
        </label>

        <label class="var-field">
          <span>Conte√∫do JRXML</span>
          <textarea
            rows="12"
            [(ngModel)]="templateDraft.jrxml"
            [ngModelOptions]="{ standalone: true }"
            placeholder="<jasperReport ...>...</jasperReport>"
          ></textarea>
        </label>

        <p class="muted" *ngIf="loadingTemplate">Carregando template...</p>
        <p class="params-error" *ngIf="templateDraftError">{{ templateDraftError }}</p>
        <p class="muted" *ngIf="templateDraftStatus">{{ templateDraftStatus }}</p>
      </div>
    </div>

    <div class="report-modal__footer report-modal__footer--spaced">
      <button
        type="button"
        class="btn btn--danger"
        (click)="deleteTemplateFromManager()"
        [disabled]="creatingTemplate || !templateDraft.id"
      >
        Excluir
      </button>
      <button
        type="button"
        class="btn btn--neutral"
        (click)="applyTemplateToReport()"
        [disabled]="!templateDraft.id"
      >
        Vincular ao relat√≥rio
      </button>
      <button type="button" class="btn btn--primary" (click)="saveTemplateFromModal()" [disabled]="creatingTemplate">
        {{ creatingTemplate ? 'Salvando...' : templateDraft.id ? 'Atualizar template' : 'Criar template' }}
      </button>
    </div>
  </div>
</dialog>
