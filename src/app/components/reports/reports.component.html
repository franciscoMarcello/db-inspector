<div class="reports-shell" [class.sidebar-collapsed]="sidebarCollapsed">
  <aside class="tree-panel" *ngIf="!sidebarCollapsed">
    <div class="tree-header">
      <div class="tree-header__row">
        <h3>Visualizador de Relatorios</h3>
        <button type="button" class="btn btn--neutral btn--icon" (click)="toggleSidebar()">
          ‚óÄ
        </button>
      </div>
      <p>{{ manageMode ? 'Gest√£o de pastas e consultas' : 'Pastas e consultas' }}</p>
    </div>

    <div class="folder-create" *ngIf="manageMode">
      <button type="button" class="btn btn--primary" (click)="openFolderManager()">
        Gerenciar pastas
      </button>
      <button type="button" class="btn btn--neutral" (click)="openTemplateManager()">
        Gerenciar templates PDF
      </button>
    </div>

    <div class="tree-filter">
      <input
        type="text"
        [(ngModel)]="treeFilter"
        [ngModelOptions]="{ standalone: true }"
        placeholder="Filtrar relat√≥rio ou pasta"
      />
      <button
        *ngIf="treeFilter"
        type="button"
        class="btn btn--neutral tree-clear-filter"
        (click)="clearTreeFilter()"
      >
        Limpar filtro
      </button>
      <button type="button" class="btn btn--secondary tree-toggle-all" (click)="toggleAllFoldersExpanded()">
        {{ allFilteredFoldersExpanded ? 'Recolher tudo' : 'Expandir tudo' }}
      </button>
    </div>

    <div class="tree-list">
      <div class="tree-folder" *ngFor="let folder of filteredFolders">
        <div class="folder-row">
          <button
            type="button"
            class="folder-btn"
            [class.archived]="folder.archived"
            [class.active]="selectedFolderId === folder.id"
            (click)="selectFolder(folder)"
          >
            <span class="arrow mini" (click)="$event.stopPropagation(); toggleFolder(folder.id)">
              {{ folder.expanded ? '‚ñæ' : '‚ñ∏' }}
            </span>
            <span class="folder-name">{{ folder.name }}</span>
            <span class="archived-badge" *ngIf="folder.archived">Arquivado</span>
            <span class="folder-count">{{ reportCountByFolder(folder) }}</span>
          </button>
          <button
            *ngIf="manageMode"
            type="button"
            class="btn btn--neutral btn--icon folder-plus"
            (click)="openCreateReportForFolder(folder, $event)"
            title="Novo relat√≥rio nesta pasta"
            aria-label="Novo relat√≥rio nesta pasta"
          >
            Ôºã
          </button>
        </div>

        <div class="tree-reports" *ngIf="folder.expanded || hasTreeFilter">
          <button
            type="button"
            class="report-leaf"
            *ngFor="let report of filteredReportsByFolder(folder)"
            [class.archived]="report.archived"
            [class.active]="selectedReportId === report.id"
            (click)="selectReport(report.id)"
          >
            <span>{{ report.name }}</span>
            <span class="archived-badge archived-badge--leaf" *ngIf="report.archived">Arquivado</span>
          </button>
          <div class="tree-empty" *ngIf="filteredReportsByFolder(folder).length === 0">Sem relat√≥rios</div>
        </div>
      </div>
      <div class="tree-empty" *ngIf="filteredFolders.length === 0">Nenhum resultado para o filtro.</div>
    </div>
  </aside>

  <main class="content-panel">
    <section class="card filters">
      <div class="title">
        <div class="title-row">
          <h2>{{ runResult?.name || selectedReport?.name || 'Relatorio' }}</h2>
          <div class="title-actions">
            <button
              *ngIf="sidebarCollapsed"
              type="button"
              class="btn btn--show-sidebar btn--sm"
              (click)="toggleSidebar()"
            >
              ‚ñ∂ Mostrar pastas
            </button>
          </div>
        </div>
        <p>{{ selectedReport?.description || 'Selecione um relatorio na arvore.' }}</p>
      </div>

      <div class="vars-panel" *ngIf="selectedReportVariables.length">
        <div class="vars-title">Par√¢metros da consulta</div>
        <div class="vars-grid">
          <label class="var-field" *ngFor="let v of selectedReportVariables">
            <span>{{ v.label || v.key }} <em *ngIf="v.required">*</em></span>
            <ng-container *ngIf="hasVariableOptions(v); else freeInput">
              <div class="var-autocomplete-wrap">
                <input
                  matInput
                  class="var-autocomplete"
                  type="text"
                  placeholder="Selecione ou digite para filtrar"
                  [matAutocomplete]="varAuto"
                  [ngModel]="variableOptionSearchText[v.key] || ''"
                  [ngModelOptions]="{ standalone: true }"
                  (ngModelChange)="onVariableOptionSearchChange(v, $event)"
                />
                <span
                  *ngIf="variableOptionsLoading(v)"
                  class="var-input-loading"
                  aria-hidden="true"
                  title="Carregando op√ß√µes"
                ></span>
                <button
                  *ngIf="
                    !variableOptionsLoading(v) &&
                    ((variableOptionSearchText[v.key] || '').trim() || (variableInputs[v.key] || '').trim())
                  "
                  type="button"
                  class="var-input-clear"
                  (mousedown)="$event.preventDefault()"
                  (click)="clearVariableOption(v)"
                  title="Limpar sele√ß√£o"
                  aria-label="Limpar sele√ß√£o"
                >
                  √ó
                </button>
              </div>
              <mat-autocomplete
                #varAuto="matAutocomplete"
                class="report-var-options-panel"
                [displayWith]="displayVariableOption"
                (optionSelected)="onVariableOptionSelected(v, $event.option.value)"
              >
                <mat-option *ngFor="let opt of filteredVariableOptionItems(v)" [value]="opt">
                  {{ opt.descricao }}
                </mat-option>
                <mat-option *ngIf="!filteredVariableOptionItems(v).length" disabled>
                  Sem op√ß√µes
                </mat-option>
              </mat-autocomplete>
            </ng-container>
            <ng-template #freeInput>
              <ng-container [ngSwitch]="v.type">
                <input
                  *ngSwitchCase="'date'"
                  type="date"
                  [(ngModel)]="variableInputs[v.key]"
                  [ngModelOptions]="{ standalone: true }"
                  (ngModelChange)="onVariableInputChanged()"
                />
                <input
                  *ngSwitchCase="'datetime'"
                  type="datetime-local"
                  [(ngModel)]="variableInputs[v.key]"
                  [ngModelOptions]="{ standalone: true }"
                  (ngModelChange)="onVariableInputChanged()"
                />
                <input
                  *ngSwitchCase="'number'"
                  type="number"
                  [(ngModel)]="variableInputs[v.key]"
                  [ngModelOptions]="{ standalone: true }"
                  (ngModelChange)="onVariableInputChanged()"
                />
                <select
                  *ngSwitchCase="'boolean'"
                  [(ngModel)]="variableInputs[v.key]"
                  [ngModelOptions]="{ standalone: true }"
                  (ngModelChange)="onVariableInputChanged()"
                >
                  <option value="">(padr√£o)</option>
                  <option value="true">true</option>
                  <option value="false">false</option>
                </select>
                <input
                  *ngSwitchDefault
                  type="text"
                  [(ngModel)]="variableInputs[v.key]"
                  [ngModelOptions]="{ standalone: true }"
                  (ngModelChange)="onVariableInputChanged()"
                />
              </ng-container>
            </ng-template>
          </label>
        </div>
      </div>

      <p class="params-error" *ngIf="paramsError">{{ paramsError }}</p>

      <div class="actions" *ngIf="manageMode">
        <button type="button" class="btn btn--primary" (click)="applyFilters()">
          <span class="btn-icon">‚ñ∂</span> Executar
        </button>
        <button type="button" class="btn btn--secondary" (click)="clearAllFilters()">
          Limpar filtros
        </button>
        <button type="button" class="btn btn--neutral" (click)="openCreateReportModal()">
          <span class="btn-icon">Ôºã</span> Novo relatorio
        </button>
        <button
          type="button"
          class="btn btn--edit"
          (click)="openEditReportModal()"
          [disabled]="!selectedReport"
        >
          <span class="btn-icon">‚úé</span> Editar
        </button>
        <button
          type="button"
          class="btn btn--archive"
          (click)="archiveSelectedReport()"
          [disabled]="!selectedReport || !!selectedReport.archived"
        >
          <span class="btn-icon">üóÇ</span> Arquivar
        </button>
        <button
          type="button"
          class="btn btn--neutral"
          (click)="unarchiveSelectedReport()"
          [disabled]="!selectedReport || !selectedReport.archived"
        >
          <span class="btn-icon">‚Ü∫</span> Desarquivar
        </button>
        <button
          type="button"
          class="btn btn--excel"
          (click)="exportExcel()"
          [disabled]="!hasResultRows"
        >
          <span class="btn-icon">‚§ì</span> Exportar Excel
        </button>
        <button
          *ngIf="canExportPdf"
          type="button"
          class="btn btn--pdf"
          (click)="exportPdf()"
          [disabled]="loadingPdf || !hasRequiredParamsForRun"
        >
          <mat-icon class="btn-icon btn-icon--pdf" aria-hidden="true">picture_as_pdf</mat-icon>
          {{ loadingPdf ? 'Gerando PDF...' : 'Exportar PDF' }}
        </button>
      </div>

      <div class="actions" *ngIf="!manageMode">
        <button type="button" class="btn btn--primary" (click)="applyFilters()">
          <span class="btn-icon">‚ñ∂</span> Executar
        </button>
        <button type="button" class="btn btn--secondary" (click)="clearAllFilters()">
          Limpar filtros
        </button>
        <button
          type="button"
          class="btn btn--excel"
          (click)="exportExcel()"
          [disabled]="!hasResultRows"
        >
          <span class="btn-icon">‚§ì</span> Exportar Excel
        </button>
        <button
          *ngIf="canExportPdf"
          type="button"
          class="btn btn--pdf"
          (click)="exportPdf()"
          [disabled]="loadingPdf || !hasRequiredParamsForRun"
        >
          <mat-icon class="btn-icon btn-icon--pdf" aria-hidden="true">picture_as_pdf</mat-icon>
          {{ loadingPdf ? 'Gerando PDF...' : 'Exportar PDF' }}
        </button>
      </div>
    </section>

    <section class="card table-card" *ngIf="runResult as result; else emptyState">
      <div class="table-meta">
        <span>Total de linhas: <strong>{{ result.meta.rowCount }}</strong></span>
        <span>Exibindo: <strong>{{ displayedRows.length }}</strong></span>
        <span *ngIf="result.meta.elapsedMs">Tempo: <strong>{{ result.meta.elapsedMs }} ms</strong></span>
      </div>
      <div class="table-wrap">
        <div class="result-loading-overlay" *ngIf="loadingRun" aria-live="polite" aria-busy="true">
          <span class="result-loading-spinner" aria-hidden="true"></span>
          <span>Executando relat√≥rio...</span>
        </div>
        <div class="no-results" *ngIf="displayedRows.length === 0">Sem resultado.</div>
        <table *ngIf="displayedRows.length > 0">
          <thead>
            <tr>
              <th *ngFor="let col of result.columns">{{ col }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of displayedRows">
              <td *ngFor="let col of result.columns">{{ row[col] }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<ng-template #emptyState>
  <section class="card table-card">
    <div class="result-loading-empty" *ngIf="loadingRun; else noResultYet">
      <span class="result-loading-spinner" aria-hidden="true"></span>
      <span>Executando relat√≥rio...</span>
    </div>
    <ng-template #noResultYet>
      <p class="muted">Nenhum resultado para exibir.</p>
    </ng-template>
  </section>
</ng-template>

<section class="card status-card" *ngIf="statusMessage || runResult?.meta">
  <div class="status-line" [ngClass]="statusToneClass" *ngIf="statusMessage">
    <strong>{{ statusTitle }}</strong>
    <span>{{ statusMessage }}</span>
  </div>
  <div class="status-meta" *ngIf="runResult?.meta as meta">
    <span>Ambiente: {{ meta.environment || 'N/A' }}</span>
    <span>Gerado em: {{ meta.generatedAt || 'N/A' }}</span>
    <span>√öltima execu√ß√£o: {{ meta.lastRunAt || 'N/A' }}</span>
    <span>Linhas: {{ meta.rowCount }}</span>
    <span>Tempo: {{ meta.elapsedMs }} ms</span>
  </div>
</section>

<app-reports-report-modal
  [open]="reportModalOpen"
  [mode]="reportModalMode"
  [reportDraft]="reportDraft"
  [reportDraftVariables]="reportDraftVariables"
  [reportDraftError]="reportDraftError"
  [folders]="folders"
  [templates]="templates"
  (close)="closeReportModal()"
  (createFolder)="createFolderFromReportModal()"
  (openTemplateManager)="openTemplateManager()"
  (sqlChanged)="onDraftSqlChanged()"
  (variablesDrop)="onDraftVariablesDrop($event)"
  (save)="saveReportFromModal()"
></app-reports-report-modal>

<app-reports-folder-manager-modal
  [open]="folderManagerOpen"
  [folders]="folders"
  [selectedFolderId]="selectedFolderId"
  [selectedFolder]="selectedFolder"
  [newFolderName]="newFolderName"
  [renameFolderName]="renameFolderName"
  (close)="closeFolderManager()"
  (selectedFolderIdChange)="onFolderManagerSelectionChange($event)"
  (newFolderNameChange)="newFolderName = $event"
  (renameFolderNameChange)="renameFolderName = $event"
  (createFolder)="createFolder()"
  (renameSelectedFolder)="renameSelectedFolder()"
  (archiveSelectedFolder)="archiveSelectedFolder()"
  (unarchiveSelectedFolder)="unarchiveSelectedFolder()"
></app-reports-folder-manager-modal>

<app-reports-template-manager-modal
  [open]="templateManagerOpen"
  [templates]="templates"
  [selectedTemplateId]="selectedTemplateId"
  [templateDraft]="templateDraft"
  [templateFileName]="templateFileName"
  [loadingTemplate]="loadingTemplate"
  [templateDraftError]="templateDraftError"
  [templateDraftStatus]="templateDraftStatus"
  [creatingTemplate]="creatingTemplate"
  (close)="closeTemplateManager()"
  (startNew)="startNewTemplate()"
  (selectTemplate)="selectTemplate($event)"
  (fileSelected)="onTemplateManagerFileSelected($event)"
  (deleteTemplate)="deleteTemplateFromManager()"
  (applyTemplate)="applyTemplateToReport()"
  (saveTemplate)="saveTemplateFromModal()"
></app-reports-template-manager-modal>
