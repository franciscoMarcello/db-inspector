<div class="reports-shell">
  <aside class="tree-panel">
    <div class="tree-header">
      <div class="tree-header__row">
        <h3>Visualizador de Relatorios</h3>
        <button type="button" class="btn btn--neutral btn--icon" (click)="openCreateReportModal()">
          Ôºã
        </button>
      </div>
      <p>Pastas e consultas</p>
    </div>

    <div class="folder-create">
      <input
        type="text"
        [(ngModel)]="newFolderName"
        placeholder="Nova pasta"
        (keydown.enter)="createFolder()"
      />
      <button type="button" class="btn btn--primary" (click)="createFolder()">Criar</button>
      <button
        type="button"
        class="btn btn--secondary"
        (click)="renameSelectedFolder()"
        [disabled]="!selectedFolder"
      >
        Renomear
      </button>
      <button
        type="button"
        class="btn btn--archive"
        (click)="archiveSelectedFolder()"
        [disabled]="!selectedFolder"
      >
        Arquivar pasta
      </button>
    </div>

    <div class="tree-list">
      <div class="tree-folder" *ngFor="let folder of folders">
        <div class="folder-row">
          <button
            type="button"
            class="folder-btn"
            [class.active]="selectedFolderId === folder.id"
            (click)="selectFolder(folder)"
          >
            <span class="arrow mini" (click)="$event.stopPropagation(); toggleFolder(folder.id)">
              {{ folder.expanded ? '‚ñæ' : '‚ñ∏' }}
            </span>
            <span class="folder-name">{{ folder.name }}</span>
            <span class="folder-count">{{ reportCountByFolder(folder) }}</span>
          </button>
          <button
            type="button"
            class="btn btn--neutral btn--icon folder-plus"
            (click)="openCreateReportForFolder(folder, $event)"
            title="Novo relat√≥rio nesta pasta"
            aria-label="Novo relat√≥rio nesta pasta"
          >
            Ôºã
          </button>
        </div>

        <div class="tree-reports" *ngIf="folder.expanded">
          <button
            type="button"
            class="report-leaf"
            *ngFor="let report of reportsByFolder(folder)"
            [class.active]="selectedReportId === report.id"
            (click)="selectReport(report.id)"
          >
            {{ report.name }}
          </button>
          <div class="tree-empty" *ngIf="reportsByFolder(folder).length === 0">Sem relat√≥rios</div>
        </div>
      </div>
    </div>
  </aside>

  <main class="content-panel">
    <section class="card filters">
      <div class="title">
        <h2>{{ runResult?.name || selectedReport?.name || 'Relatorio' }}</h2>
        <p>{{ selectedReport?.description || 'Selecione um relatorio na arvore.' }}</p>
      </div>

      <div class="vars-panel" *ngIf="selectedReportVariables.length">
        <div class="vars-title">Par√¢metros da consulta</div>
        <div class="vars-grid">
          <label class="var-field" *ngFor="let v of selectedReportVariables">
            <span>{{ v.label || v.key }} <em *ngIf="v.required">*</em></span>
            <ng-container [ngSwitch]="v.type">
              <input
                *ngSwitchCase="'date'"
                type="date"
                [(ngModel)]="variableInputs[v.key]"
                [ngModelOptions]="{ standalone: true }"
              />
              <input
                *ngSwitchCase="'datetime'"
                type="datetime-local"
                [(ngModel)]="variableInputs[v.key]"
                [ngModelOptions]="{ standalone: true }"
              />
              <input
                *ngSwitchCase="'number'"
                type="number"
                [(ngModel)]="variableInputs[v.key]"
                [ngModelOptions]="{ standalone: true }"
              />
              <select
                *ngSwitchCase="'boolean'"
                [(ngModel)]="variableInputs[v.key]"
                [ngModelOptions]="{ standalone: true }"
              >
                <option value="">(padr√£o)</option>
                <option value="true">true</option>
                <option value="false">false</option>
              </select>
              <input
                *ngSwitchDefault
                type="text"
                [(ngModel)]="variableInputs[v.key]"
                [ngModelOptions]="{ standalone: true }"
              />
            </ng-container>
          </label>
        </div>
      </div>

      <p class="params-error" *ngIf="paramsError">{{ paramsError }}</p>

      <div class="actions">
        <button type="button" class="btn btn--primary" (click)="applyFilters()">
          <span class="btn-icon">‚ñ∂</span> Executar
        </button>
        <button type="button" class="btn btn--neutral" (click)="openCreateReportModal()">
          <span class="btn-icon">Ôºã</span> Novo relatorio
        </button>
        <button
          type="button"
          class="btn btn--edit"
          (click)="openEditReportModal()"
          [disabled]="!selectedReport"
        >
          <span class="btn-icon">‚úé</span> Editar
        </button>
        <button
          type="button"
          class="btn btn--archive"
          (click)="archiveSelectedReport()"
          [disabled]="!selectedReport"
        >
          <span class="btn-icon">üóÇ</span> Arquivar
        </button>
        <button
          type="button"
          class="btn btn--excel"
          (click)="exportExcel()"
          [disabled]="!hasResultRows"
        >
          <span class="btn-icon">‚§ì</span> Exportar Excel
        </button>
      </div>
    </section>

    <section class="card table-card" *ngIf="runResult as result; else emptyState">
      <div class="table-meta">
        <span>Total de linhas: <strong>{{ result.meta.rowCount }}</strong></span>
        <span>Exibindo: <strong>{{ displayedRows.length }}</strong></span>
        <span *ngIf="result.meta.elapsedMs">Tempo: <strong>{{ result.meta.elapsedMs }} ms</strong></span>
      </div>
      <div class="table-wrap">
        <div class="no-results" *ngIf="displayedRows.length === 0">Sem resultado.</div>
        <table *ngIf="displayedRows.length > 0">
          <thead>
            <tr>
              <th *ngFor="let col of result.columns">{{ col }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of displayedRows">
              <td *ngFor="let col of result.columns">{{ row[col] }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<ng-template #emptyState>
  <section class="card table-card">
    <p class="muted">{{ loadingRun ? 'Executando relatorio...' : 'Nenhum resultado para exibir.' }}</p>
  </section>
</ng-template>

<section class="card status-card" *ngIf="statusMessage">
  <div class="status-line" [ngClass]="statusToneClass">
    <strong>{{ statusTitle }}</strong>
    <span>{{ statusMessage }}</span>
  </div>
  <div class="status-meta" *ngIf="runResult?.meta as meta">
    <span>Ambiente: {{ meta.environment || 'N/A' }}</span>
    <span>Gerado em: {{ meta.generatedAt || 'N/A' }}</span>
    <span>√öltima execu√ß√£o: {{ meta.lastRunAt || 'N/A' }}</span>
    <span>Linhas: {{ meta.rowCount }}</span>
    <span>Tempo: {{ meta.elapsedMs }} ms</span>
  </div>
</section>

<dialog class="report-modal" [open]="reportModalOpen">
  <div class="report-modal__panel">
    <div class="report-modal__header">
      <h3>{{ reportModalMode === 'create' ? 'Novo relat√≥rio' : 'Editar relat√≥rio' }}</h3>
      <button type="button" class="btn btn--secondary" (click)="closeReportModal()">Fechar</button>
    </div>

    <div class="report-modal__body">
      <label class="var-field">
        <span>Nome</span>
        <input
          type="text"
          [(ngModel)]="reportDraft.name"
          [ngModelOptions]="{ standalone: true }"
          placeholder="Nome do relat√≥rio"
        />
      </label>

      <label class="var-field">
        <span>Pasta</span>
        <select [(ngModel)]="reportDraft.folderId" [ngModelOptions]="{ standalone: true }">
          <option *ngFor="let folder of folders" [value]="folder.id">{{ folder.name }}</option>
        </select>
      </label>

      <label class="var-field">
        <span>Descri√ß√£o</span>
        <input
          type="text"
          [(ngModel)]="reportDraft.description"
          [ngModelOptions]="{ standalone: true }"
          placeholder="Descri√ß√£o (opcional)"
        />
      </label>

      <label class="var-field">
        <span>SQL</span>
        <textarea
          rows="10"
          [(ngModel)]="reportDraft.sql"
          [ngModelOptions]="{ standalone: true }"
          (input)="onDraftSqlChanged()"
          placeholder="SELECT * FROM ... WHERE data >= :data_inicio"
        ></textarea>
      </label>

      <div class="vars-panel">
        <div class="vars-title">Vari√°veis detectadas</div>
        <div class="draft-vars-empty" *ngIf="!reportDraftVariables.length">
          Nenhum placeholder :variavel detectado na SQL.
        </div>
        <div class="draft-vars-grid" *ngIf="reportDraftVariables.length">
          <div class="draft-vars-head">Usar</div>
          <div class="draft-vars-head">Key</div>
          <div class="draft-vars-head">Label</div>
          <div class="draft-vars-head">Tipo</div>
          <div class="draft-vars-head">Obrigat√≥ria</div>
          <div class="draft-vars-head">Padr√£o</div>

          <ng-container *ngFor="let v of reportDraftVariables">
            <div>
              <input type="checkbox" [(ngModel)]="v.enabled" [ngModelOptions]="{ standalone: true }" />
            </div>
            <div>{{ v.key }}</div>
            <div>
              <input type="text" [(ngModel)]="v.label" [ngModelOptions]="{ standalone: true }" />
            </div>
            <div>
              <select [(ngModel)]="v.type" [ngModelOptions]="{ standalone: true }">
                <option value="string">string</option>
                <option value="number">number</option>
                <option value="date">date</option>
                <option value="datetime">datetime</option>
                <option value="boolean">boolean</option>
              </select>
            </div>
            <div>
              <input type="checkbox" [(ngModel)]="v.required" [ngModelOptions]="{ standalone: true }" />
            </div>
            <div>
              <input
                type="text"
                [(ngModel)]="v.defaultValue"
                [ngModelOptions]="{ standalone: true }"
                placeholder="opcional"
              />
            </div>
          </ng-container>
        </div>
      </div>

      <p class="params-error" *ngIf="reportDraftError">{{ reportDraftError }}</p>
    </div>

    <div class="report-modal__footer">
      <button type="button" class="btn btn--primary" (click)="saveReportFromModal()">Salvar</button>
    </div>
  </div>
</dialog>
