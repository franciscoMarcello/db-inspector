<dialog class="report-modal" [open]="open">
  <div class="report-modal__panel">
    <div class="report-modal__header">
      <h3>Gerenciar templates PDF</h3>
      <app-button type="button" tone="neutral" variant="outline" (pressed)="close.emit()">Fechar</app-button>
    </div>

    <div class="report-modal__body template-manager">
      <div class="template-manager__list">
        <div class="template-manager__top">
          <app-button type="button" tone="neutral" variant="outline" (pressed)="startNew.emit()">Novo</app-button>
        </div>
        <button
          type="button"
          class="template-item"
          *ngFor="let template of templates"
          [class.active]="template.id === selectedTemplateId"
          (click)="selectTemplate.emit(template.id)"
        >
          {{ template.name }}
        </button>
        <p class="muted" *ngIf="!templates.length">Nenhum template cadastrado.</p>
      </div>

      <div class="template-manager__form">
        <label class="var-field">
          <span>Nome</span>
          <input
            type="text"
            [(ngModel)]="templateDraft.name"
            [ngModelOptions]="{ standalone: true }"
            placeholder="Ex.: Curral PDF"
          />
        </label>

        <label class="var-field">
          <span>Descrição</span>
          <input
            type="text"
            [(ngModel)]="templateDraft.description"
            [ngModelOptions]="{ standalone: true }"
            placeholder="Opcional"
          />
        </label>

        <label class="var-field">
          <span>Arquivo JRXML</span>
          <div class="file-picker">
            <app-button type="button" class="file-picker__btn" tone="neutral" variant="outline" (pressed)="openFilePicker(templateFileInput)">
              Escolher arquivo
            </app-button>
            <input
              #templateFileInput
              id="template-jrxml-file"
              type="file"
              accept=".jrxml,application/xml,text/xml"
              (change)="fileSelected.emit($event)"
            />
            <span class="file-picker__name">
              {{ templateFileName || 'Nenhum arquivo selecionado' }}
            </span>
          </div>
        </label>

        <label class="var-field">
          <span>Conteúdo JRXML</span>
          <textarea
            rows="12"
            [(ngModel)]="templateDraft.jrxml"
            [ngModelOptions]="{ standalone: true }"
            placeholder="<jasperReport ...>...</jasperReport>"
          ></textarea>
        </label>

        <p class="muted" *ngIf="loadingTemplate">Carregando template...</p>
        <p class="params-error" *ngIf="templateDraftError">{{ templateDraftError }}</p>
        <p class="muted" *ngIf="templateDraftStatus">{{ templateDraftStatus }}</p>
      </div>
    </div>

    <div class="report-modal__footer report-modal__footer--spaced">
      <app-button
        type="button"
        tone="danger"
        variant="outline"
        (pressed)="deleteTemplate.emit()"
        [disabled]="creatingTemplate || !templateDraft.id"
      >
        Excluir
      </app-button>
      <app-button
        type="button"
        tone="neutral"
        variant="outline"
        (pressed)="applyTemplate.emit()"
        [disabled]="!templateDraft.id"
      >
        Vincular ao relatório
      </app-button>
      <app-button type="button" tone="primary" variant="solid" (pressed)="saveTemplate.emit()" [disabled]="creatingTemplate">
        {{ creatingTemplate ? 'Salvando...' : templateDraft.id ? 'Atualizar template' : 'Criar template' }}
      </app-button>
    </div>
  </div>
</dialog>
