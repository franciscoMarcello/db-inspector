<dialog class="report-modal" [open]="open">
  <div class="report-modal__panel report-modal__panel--wide">
    <div class="report-modal__header">
      <h3>{{ mode === 'create' ? 'Novo relatório' : 'Editar relatório' }}</h3>
      <button type="button" class="btn btn--secondary" (click)="close.emit()">Fechar</button>
    </div>

    <div class="report-modal__body">
      <label class="var-field">
        <span>Nome</span>
        <input
          type="text"
          [(ngModel)]="reportDraft.name"
          [ngModelOptions]="{ standalone: true }"
          placeholder="Nome do relatório"
        />
      </label>

      <label class="var-field">
        <span>Pasta</span>
        <div class="folder-picker">
          <select [(ngModel)]="reportDraft.folderId" [ngModelOptions]="{ standalone: true }">
            <option *ngFor="let folder of folders" [value]="folder.id">{{ folder.name }}</option>
          </select>
          <button type="button" class="btn btn--neutral" (click)="createFolder.emit()">
            + Pasta
          </button>
        </div>
      </label>

      <label class="var-field">
        <span>Template PDF (Jasper)</span>
        <div class="template-picker">
          <select [(ngModel)]="reportDraft.jasperTemplateId" [ngModelOptions]="{ standalone: true }">
            <option value="">Sem template</option>
            <option *ngFor="let template of templates" [value]="template.id">{{ template.name }}</option>
          </select>
          <button type="button" class="btn btn--neutral" (click)="openTemplateManager.emit()">
            Gerenciar templates
          </button>
        </div>
      </label>

      <label class="var-field">
        <span>Descrição</span>
        <input
          type="text"
          [(ngModel)]="reportDraft.description"
          [ngModelOptions]="{ standalone: true }"
          placeholder="Descrição (opcional)"
        />
      </label>

      <label class="var-field">
        <span>SQL</span>
        <textarea
          rows="10"
          [(ngModel)]="reportDraft.sql"
          [ngModelOptions]="{ standalone: true }"
          (input)="sqlChanged.emit()"
          placeholder="SELECT * FROM ... WHERE data >= :data_inicio"
        ></textarea>
      </label>

      <div class="vars-panel">
        <div class="vars-title">Variáveis detectadas</div>
        <div class="draft-vars-empty" *ngIf="!reportDraftVariables.length">
          Nenhum placeholder :variavel detectado na SQL.
        </div>
        <div class="draft-vars-grid" *ngIf="reportDraftVariables.length">
          <div class="draft-vars-head-row">
            <div class="draft-vars-head">Ordem</div>
            <div class="draft-vars-head">Key</div>
            <div class="draft-vars-head">Label</div>
            <div class="draft-vars-head">Tipo</div>
            <div class="draft-vars-head">Obrigatória</div>
            <div class="draft-vars-head">Padrão</div>
            <div class="draft-vars-head">SQL opções</div>
          </div>

          <div cdkDropList [cdkDropListData]="reportDraftVariables" (cdkDropListDropped)="variablesDrop.emit($event)">
            <div class="draft-vars-row" *ngFor="let v of reportDraftVariables" cdkDrag>
              <div class="draft-order-controls" cdkDragHandle title="Arraste para ordenar">
                ⋮⋮
              </div>
              <div>{{ v.key }}</div>
              <div>
                <input type="text" [(ngModel)]="v.label" [ngModelOptions]="{ standalone: true }" />
              </div>
              <div>
                <select [(ngModel)]="v.type" [ngModelOptions]="{ standalone: true }">
                  <option value="string">string</option>
                  <option value="number">number</option>
                  <option value="date">date</option>
                  <option value="datetime">datetime</option>
                  <option value="boolean">boolean</option>
                </select>
              </div>
              <div>
                <input type="checkbox" [(ngModel)]="v.required" [ngModelOptions]="{ standalone: true }" />
              </div>
              <div>
                <input
                  type="text"
                  [(ngModel)]="v.defaultValue"
                  [ngModelOptions]="{ standalone: true }"
                  placeholder="opcional"
                />
              </div>
              <div>
                <textarea
                  rows="2"
                  [(ngModel)]="v.optionsSql"
                  [ngModelOptions]="{ standalone: true }"
                  placeholder="SELECT id AS valor, nome AS descricao FROM ... WHERE ..."
                ></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>

      <p class="params-error" *ngIf="reportDraftError">{{ reportDraftError }}</p>
    </div>

    <div class="report-modal__footer">
      <button type="button" class="btn btn--primary" (click)="save.emit()">Salvar</button>
    </div>
  </div>
</dialog>
