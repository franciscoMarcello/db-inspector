<h3>Executar SQL</h3>
<div class="fav-bar">
  <div class="fav-left">
    <div class="fav-left-main">
      <strong>Favoritos</strong>
      <input
        *ngIf="!snippetsCollapsed"
        type="text"
        placeholder="Filtrar..."
        [(ngModel)]="snippetFilter"
        [ngModelOptions]="{ standalone: true }"
      />
    </div>
    <button class="snippet-toggle-btn" (click)="toggleSnippetsPanel()">
      <mat-icon aria-hidden="true">
        {{ snippetsCollapsed ? 'unfold_more' : 'unfold_less' }}
      </mat-icon>
      {{ snippetsCollapsed ? 'Mostrar snippets' : 'Ocultar snippets' }}
    </button>
  </div>

  <div class="folder-bar" *ngIf="!snippetsCollapsed">
    <button
      class="chip folder-chip"
      [class.active]="selectedFolder === null"
      (click)="selectFolder(null)"
    >
      <mat-icon aria-hidden="true">folder_special</mat-icon>
      Todas as pastas
    </button>
    <button
      class="chip folder-chip"
      *ngFor="let folder of folders; trackBy: trackFolder"
      [class.active]="selectedFolder === folder"
      (click)="selectFolder(folder)"
    >
      <mat-icon aria-hidden="true">folder</mat-icon>
      {{ folderLabel(folder) }}
    </button>
    <button class="link small" (click)="createFolder()">+ nova pasta</button>
  </div>

  <div class="fav-row" *ngIf="!snippetsCollapsed">
    <ng-container *ngIf="snippets.length; else noSnips">
      <div class="fav-chips">
        <button
          class="chip"
          *ngFor="let s of snippets; trackBy: trackSnippetId"
          [hidden]="!shouldShowSnippet(s)"
          (click)="loadSnippet(s.id)"
          [class.active]="s.id === selectedSnippetId"
          title="{{ s.name }}"
        >
          {{ s.name }}
        </button>
      </div>
    </ng-container>

    <div class="fav-actions">
      <button class="link" (click)="selectedSnippetId && renameSnippet(selectedSnippetId)">
        renomear
      </button>
      <button class="link danger" (click)="selectedSnippetId && deleteSnippet(selectedSnippetId)">
        excluir
      </button>
      <button class="link" (click)="saveOnSelectedSnippet()">salvar (Ctrl+S)</button>
      <button class="link" (click)="selectedSnippetId && moveSnippetToFolder(selectedSnippetId)">
        mover p/ pasta
      </button>
      <button class="link" (click)="exportSnippets()" [disabled]="!snippets.length">exportar</button>
      <button class="link" (click)="importSnippets()">importar</button>
    </div>
  </div>

  <ng-template #noSnips>
    <div class="no-snips muted">
      Sem favoritos. Use “salvar (Ctrl+S)” ou
      <button class="link" (click)="importSnippets()">importe um arquivo</button>.
    </div>
  </ng-template>
</div>

<div #editorHost class="editor-resize">
  <ngx-monaco-editor
    [(ngModel)]="query"
    [options]="editorOptions"
    (onInit)="onEditorInit($event)"
    [ngModelOptions]="{ standalone: true }"
  >
  </ngx-monaco-editor>
</div>

<div class="toolbar">
  <div class="btns">
    <app-button tone="primary" variant="solid" (pressed)="runPaged()">Executar (Ctrl+Enter)</app-button>
    <app-button tone="neutral" variant="outline" (pressed)="openScheduleDialog()">
      Agendar envio por e-mail
    </app-button>
    <app-button tone="neutral" variant="outline" (pressed)="copyResultsForExcel()" [disabled]="rows.length === 0">
      Exportar Excel
    </app-button>
    <app-button tone="neutral" variant="outline" (pressed)="saveQueryAsSql()">Salvar .sql</app-button>
    <app-button tone="neutral" variant="outline" (pressed)="saveAsReport()">Salvar como relatório</app-button>
    <app-button tone="neutral" variant="outline" (pressed)="saveCurrentAsSnippet()">Salvar favorito (Ctrl+S)</app-button>
  </div>
  <span class="meta">
    {{ usingAllMode ? 'modo all' : 'página ' + page }} • {{ rowCount }} linhas • {{ elapsedMs }} ms
    •
    {{ lastRunAt ? (lastRunAt | date : 'dd/MM/yyyy HH:mm:ss') : '—' }}
  </span>
</div>

<mat-progress-bar *ngIf="loading" mode="indeterminate"></mat-progress-bar>

<div *ngIf="error" class="error">{{ error }}</div>

<mat-card class="result-card" *ngIf="!loading && !error">
  <div *ngIf="rowCount === 0; else hasData" class="muted">Sem resultados.</div>

  <ng-template #hasData>
    <div class="table-wrap">
      <table mat-table [dataSource]="rows" class="mat-elevation-z1 result-table">
        <ng-container *ngFor="let col of displayedColumns" [matColumnDef]="col">
          <th mat-header-cell *matHeaderCellDef>{{ col }}</th>
          <td mat-cell *matCellDef="let row">{{ row[col] }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
    </div>
  </ng-template>
</mat-card>

<div class="result-controls" *ngIf="!loading && !error">
  <div class="btns">
    <app-button tone="neutral" variant="outline" (pressed)="runAll()">Executar tudo (/query/all)</app-button>
    <app-button tone="neutral" variant="outline" *ngIf="!usingAllMode && canGoPrev" (pressed)="prevPage()">
      Página anterior
    </app-button>
    <app-button tone="neutral" variant="outline" *ngIf="!usingAllMode && canGoNext" (pressed)="nextPage()">
      Próxima página
    </app-button>
    <label class="small size-field" *ngIf="!usingAllMode">
      size
      <input
        class="page-size-input"
        type="number"
        min="1"
        [max]="maxPageSize"
        [(ngModel)]="size"
        [ngModelOptions]="{ standalone: true }"
        (change)="onPageSizeChange()"
      />
    </label>
  </div>
  <span class="meta">
    {{ usingAllMode ? 'modo all' : 'página ' + page }} • {{ rowCount }} linhas • {{ elapsedMs }} ms
    •
    {{ lastRunAt ? (lastRunAt | date : 'dd/MM/yyyy HH:mm:ss') : '—' }}
  </span>
</div>
