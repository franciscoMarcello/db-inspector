<section class="admin-shell">
  <div class="admin-grid">
    <div class="card card-header">
      <h2>Usuários</h2>
      <p class="muted">Gerencie criação, ativação e permissões de acesso.</p>
      <div class="status-row">
        <div class="status error" *ngIf="error">{{ error }}</div>
        <div class="status ok" *ngIf="status">{{ status }}</div>
      </div>
    </div>

    <div class="card card-create">
      <div class="card-head">
        <h3>Criar usuário</h3>
      </div>

      <div class="create-form">
        <label class="field">
          <span>E-mail</span>
          <input type="email" [(ngModel)]="createForm.email" [ngModelOptions]="{ standalone: true }" placeholder="usuario@empresa.com" />
        </label>

        <label class="field">
          <span>Senha</span>
          <input type="password" [(ngModel)]="createForm.password" [ngModelOptions]="{ standalone: true }" placeholder="Mínimo 6 caracteres" />
        </label>

        <label class="check">
          <input type="checkbox" [(ngModel)]="createForm.active" [ngModelOptions]="{ standalone: true }" />
          Ativo
        </label>

        <div class="roles-picker">
          <span class="roles-label">Roles iniciais</span>
          <div class="roles-pick-list">
            <label class="check inline" *ngFor="let role of availableRoleNames()">
              <input
                type="checkbox"
                [checked]="createForm.roles.has(role)"
                (change)="toggleCreateRole(role, $any($event.target).checked)"
              />
              {{ role }}
            </label>
          </div>
        </div>

        <button type="button" class="btn primary" (click)="createUser()" [disabled]="saving">
          {{ saving ? 'Criando...' : 'Criar usuário' }}
        </button>
      </div>
    </div>

    <div class="card card-users">
      <div class="card-head">
        <h3>Lista de usuários</h3>
        <button type="button" class="btn" (click)="loadAll()" [disabled]="loading">
          {{ loading ? 'Atualizando...' : 'Atualizar' }}
        </button>
      </div>

      <div class="users-list">
        <div class="user-row" *ngFor="let user of users; trackBy: trackUser">
          <div class="user-row-head">
            <div class="user-main">
              <div class="email">{{ user.email }}</div>
              <div class="meta">ID: {{ user.id }}</div>
              <div class="meta">
                Criado: {{ user.createdAt | date : 'dd/MM/yyyy HH:mm' }} • Atualizado:
                {{ user.updatedAt | date : 'dd/MM/yyyy HH:mm' }}
              </div>
            </div>

            <div class="user-actions">
              <label class="check inline">
                <input
                  type="checkbox"
                  [checked]="user.active"
                  (change)="setUserActive(user, $any($event.target).checked)"
                />
                {{ user.active ? 'Ativo' : 'Inativo' }}
              </label>

              <button type="button" class="btn" (click)="revokeRefreshTokens(user)">
                Revogar refresh tokens
              </button>
            </div>
          </div>

          <div class="roles-row">
            <span class="roles-title">Roles:</span>
            <span class="role-chip" *ngFor="let role of user.roles">
              {{ role }}
              <button type="button" class="chip-remove" (click)="removeRole(user, role)">×</button>
            </span>
          </div>

          <div class="add-role-row">
            <select [(ngModel)]="roleToAddByUser[user.id]" [ngModelOptions]="{ standalone: true }">
              <option value="">Selecionar role</option>
              <option *ngFor="let role of availableRoleNames()" [value]="role">{{ role }}</option>
            </select>
            <button type="button" class="btn" (click)="addRole(user)">Adicionar role</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card card-roles">
      <div class="card-head">
        <h3>Roles</h3>
        <button type="button" class="btn primary" (click)="startCreateRole()">Nova role</button>
      </div>

      <div class="role-editor" *ngIf="roleEditorOpen">
        <div class="role-editor-head">
          <strong>{{ roleEditorMode === 'create' ? 'Criar role' : 'Editar role' }}</strong>
          <button type="button" class="btn" (click)="cancelRoleEditor()">Cancelar</button>
        </div>

        <label class="field">
          <span>Nome da role</span>
          <input
            type="text"
            [(ngModel)]="roleForm.name"
            [ngModelOptions]="{ standalone: true }"
            placeholder="Ex.: ANALISTA"
          />
        </label>

        <div class="roles-picker">
          <span class="roles-label">Permissões</span>
          <div class="roles-pick-list">
            <label
              class="check inline permission-option"
              *ngFor="let permission of permissionsCatalog; trackBy: trackPermissionCatalog"
              [title]="permission.description || permission.code"
            >
              <input
                type="checkbox"
                [checked]="roleForm.permissions.has(permission.code)"
                (change)="toggleRolePermission(permission.code, $any($event.target).checked)"
              />
              <span class="permission-option__text">
                <span class="permission-option__label">{{ permission.label || permission.code }}</span>
                <span class="permission-option__code">{{ permission.code }}</span>
              </span>
            </label>
          </div>
        </div>

        <button type="button" class="btn primary" [disabled]="roleSaving" (click)="saveRole()">
          {{ roleSaving ? 'Salvando...' : 'Salvar role' }}
        </button>
      </div>

      <div class="roles-def-list">
        <div class="role-def" *ngFor="let role of roles; trackBy: trackRole">
          <div class="role-def-head">
            <strong>{{ role.name }}</strong>
            <div class="role-def-actions">
              <button type="button" class="btn btn-sm" (click)="startEditRole(role.name)">Editar</button>
              <button
                type="button"
                class="btn btn-sm danger"
                [disabled]="isSystemRole(role.name)"
                (click)="deleteRole(role.name)"
              >
                Excluir
              </button>
            </div>
          </div>
          <div class="perm-list">
            <span
              class="perm-chip"
              *ngFor="let perm of role.permissions"
              [title]="permissionDescription(perm) || perm"
            >
              {{ permissionLabel(perm) }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <div class="card card-permissions">
      <h3>Todas as permissões</h3>
      <div class="perm-list">
        <span
          class="perm-chip"
          *ngFor="let perm of permissionsCatalog; trackBy: trackPermissionCatalog"
          [title]="perm.description || perm.code"
        >
          {{ perm.label || perm.code }}
        </span>
      </div>
    </div>

    <div class="card card-acl">
      <div class="card-head">
        <h3>ACL de pastas e relatórios</h3>
        <button type="button" class="btn" (click)="refreshAclRules()" [disabled]="aclLoading">
          {{ aclLoading ? 'Carregando...' : 'Atualizar ACL' }}
        </button>
      </div>

      <div class="acl-grid">
        <label class="field">
          <span>Tipo de alvo</span>
          <select
            [ngModel]="aclEntityType"
            [ngModelOptions]="{ standalone: true }"
            (ngModelChange)="onAclEntityTypeChange($event)"
          >
            <option value="FOLDER">Pasta</option>
            <option value="REPORT">Relatório</option>
          </select>
        </label>

        <label class="field">
          <span>Alvo</span>
          <select
            [ngModel]="aclTargetId"
            [ngModelOptions]="{ standalone: true }"
            (ngModelChange)="onAclTargetChange($event)"
          >
            <option value="">Selecione</option>
            <ng-container *ngIf="aclEntityType === 'FOLDER'; else reportAclTargets">
              <option *ngFor="let folder of aclFolders" [value]="folder.id">
                {{ folder.name }}
              </option>
            </ng-container>
            <ng-template #reportAclTargets>
              <option *ngFor="let report of aclReports" [value]="report.id">
                {{ report.name }}
              </option>
            </ng-template>
          </select>
        </label>
      </div>

      <div class="acl-editor">
        <label class="field">
          <span>Subject Type</span>
          <select
            [ngModel]="aclDraft.subjectType"
            [ngModelOptions]="{ standalone: true }"
            (ngModelChange)="onAclSubjectTypeChange($event)"
          >
            <option value="ROLE">ROLE</option>
            <option value="USER">USER</option>
          </select>
        </label>

        <ng-container *ngIf="aclDraft.subjectType === 'ROLE'; else aclUserSubject">
          <label class="field">
            <span>Role</span>
            <select
              [ngModel]="aclDraft.subject"
              [ngModelOptions]="{ standalone: true }"
              (ngModelChange)="onAclDraftFieldChange('subject', $event)"
            >
              <option value="">Selecione uma role</option>
              <option *ngFor="let role of roles; trackBy: trackRole" [value]="role.name">
                {{ role.name }}
              </option>
            </select>
          </label>
        </ng-container>
        <ng-template #aclUserSubject>
          <label class="field">
            <span>Usuário (UUID)</span>
            <input
              type="text"
              [ngModel]="aclDraft.subject"
              [ngModelOptions]="{ standalone: true }"
              (ngModelChange)="onAclDraftFieldChange('subject', $event)"
              placeholder="uuid do usuário"
            />
          </label>
        </ng-template>

        <div class="acl-flags">
          <label class="check acl-flag">
            <input
              type="checkbox"
              [ngModel]="aclDraft.canView"
              [ngModelOptions]="{ standalone: true }"
              (ngModelChange)="onAclDraftFieldChange('canView', $event)"
            />
            Pode visualizar
          </label>
          <label class="check acl-flag">
            <input
              type="checkbox"
              [ngModel]="aclDraft.canRun"
              [ngModelOptions]="{ standalone: true }"
              (ngModelChange)="onAclDraftFieldChange('canRun', $event)"
            />
            Pode executar
          </label>
          <label class="check acl-flag">
            <input
              type="checkbox"
              [ngModel]="aclDraft.canEdit"
              [ngModelOptions]="{ standalone: true }"
              (ngModelChange)="onAclDraftFieldChange('canEdit', $event)"
            />
            Pode editar
          </label>
          <label class="check acl-flag">
            <input
              type="checkbox"
              [ngModel]="aclDraft.canDelete"
              [ngModelOptions]="{ standalone: true }"
              (ngModelChange)="onAclDraftFieldChange('canDelete', $event)"
            />
            Pode excluir
          </label>
        </div>

        <button type="button" class="btn primary" (click)="saveAclRule()" [disabled]="aclSaving || !aclTargetId">
          {{ aclSaving ? 'Salvando...' : 'Salvar regra ACL' }}
        </button>
      </div>

      <div class="acl-list">
        <div class="muted" *ngIf="!aclTargetId">Selecione um alvo para visualizar ACL.</div>
        <div class="muted" *ngIf="aclTargetId && aclLoading">Carregando regras ACL...</div>
        <div class="muted" *ngIf="aclTargetId && !aclLoading && !aclRules.length">Sem regras ACL cadastradas.</div>

        <div class="acl-row" *ngFor="let rule of aclRules; trackBy: trackAclRule">
          <div class="acl-row__main">
            <strong class="acl-subject-type">{{ rule.subjectType }}</strong>
            <span>{{ rule.subject }}</span>
          </div>
          <div class="acl-row__flags">
            <span class="perm-chip">view: {{ rule.canView ? 'sim' : 'não' }}</span>
            <span class="perm-chip">run: {{ rule.canRun ? 'sim' : 'não' }}</span>
            <span class="perm-chip">edit: {{ rule.canEdit ? 'sim' : 'não' }}</span>
            <span class="perm-chip">delete: {{ rule.canDelete ? 'sim' : 'não' }}</span>
          </div>
          <button type="button" class="btn btn-sm danger" (click)="removeAclRule(rule)">
            Remover
          </button>
        </div>
      </div>
    </div>
  </div>
</section>
