<section class="admin-shell">
  <div class="admin-grid">
    <div class="card card-header">
      <div class="card-head">
        <div>
          <h2>{{ adminSection === 'USERS' ? 'Usuários' : 'Permissões' }}</h2>
          <p class="muted">
            {{ adminSection === 'USERS'
              ? 'Gerencie criação, ativação e permissões de acesso.'
              : 'Gerencie perfis e regras ACL de pastas e relatórios.' }}
          </p>
        </div>
        <app-button *ngIf="adminSection === 'USERS'" tone="primary" variant="solid" (pressed)="openCreateUserModal()">
          Criar usuário
        </app-button>
      </div>
      <div class="status-row">
        <div class="status error" *ngIf="error && !anyModalOpen">{{ error }}</div>
        <div class="status ok" *ngIf="status && !anyModalOpen">{{ status }}</div>
      </div>
    </div>

    <div class="card card-users" *ngIf="adminSection === 'USERS'">
      <div class="card-head">
        <h3>Lista de usuários</h3>
        <div class="users-head-actions">
          <input
            type="text"
            [(ngModel)]="userSearchTerm"
            [ngModelOptions]="{ standalone: true }"
            placeholder="Filtrar por nome ou e-mail"
            aria-label="Filtrar usuários por nome ou e-mail"
          />
          <app-button tone="neutral" variant="outline" (pressed)="loadAll()" [disabled]="loading">
            {{ loading ? 'Atualizando...' : 'Atualizar' }}
          </app-button>
        </div>
      </div>

      <div class="users-toolbar">
        <div class="users-status-filters">
          <app-button size="sm" [tone]="userStatusFilter === 'ALL' ? 'primary' : 'neutral'" [variant]="userStatusFilter === 'ALL' ? 'solid' : 'outline'" (pressed)="userStatusFilter = 'ALL'">Todos ({{ userStatusCount('ALL') }})</app-button>
          <app-button size="sm" [tone]="userStatusFilter === 'ACTIVE' ? 'primary' : 'neutral'" [variant]="userStatusFilter === 'ACTIVE' ? 'solid' : 'outline'" (pressed)="userStatusFilter = 'ACTIVE'">Ativos ({{ userStatusCount('ACTIVE') }})</app-button>
          <app-button size="sm" [tone]="userStatusFilter === 'INACTIVE' ? 'danger' : 'neutral'" [variant]="userStatusFilter === 'INACTIVE' ? 'solid' : 'outline'" (pressed)="userStatusFilter = 'INACTIVE'">Inativos ({{ userStatusCount('INACTIVE') }})</app-button>
          <app-reports-multi-select
            class="users-profile-filter"
            [options]="userProfileFilterOptions()"
            [selectedValues]="userProfileFilters"
            [placeholder]="'Filtrar por perfil'"
            (selectedValuesChange)="onUserProfileFiltersChange($event)"
          ></app-reports-multi-select>
        </div>
        <small class="users-last-update" *ngIf="usersLastUpdatedAt">Atualizado: {{ usersLastUpdatedAt | date : 'dd/MM/yyyy HH:mm:ss' }}</small>
      </div>

      <div class="users-bulk-actions" [class.active]="selectedUsersCount() > 0" [attr.aria-hidden]="selectedUsersCount() > 0 ? null : true">
        <ng-container *ngIf="selectedUsersCount() > 0; else bulkEmpty">
          <span class="users-bulk-label">{{ selectedUsersCount() }} usuário(s) selecionado(s)</span>
          <div class="table-actions">
            <app-button size="sm" tone="neutral" variant="outline" [disabled]="bulkUsersLoading" (pressed)="setSelectedUsersActive(true)">
              Ativar
            </app-button>
            <app-button size="sm" tone="neutral" variant="outline" [disabled]="bulkUsersLoading" (pressed)="setSelectedUsersActive(false)">
              Desativar
            </app-button>
            <app-button size="sm" tone="neutral" variant="outline" [disabled]="bulkUsersLoading" (pressed)="revokeRefreshTokensBulk()">
              Revogar refresh
            </app-button>
            <select
              [(ngModel)]="bulkTargetRole"
              [ngModelOptions]="{ standalone: true }"
              [disabled]="bulkUsersLoading"
              aria-label="Selecionar perfil para alterar em lote"
            >
              <option value="">Aplicar perfil...</option>
              <option *ngFor="let role of roles" [value]="role.name">{{ role.name }}</option>
            </select>
            <app-button size="sm" tone="neutral" variant="outline" [disabled]="bulkUsersLoading || !bulkTargetRole" (pressed)="applyBulkRole()">
              Aplicar perfil
            </app-button>
            <app-button size="sm" tone="neutral" variant="outline" [disabled]="bulkUsersLoading" (pressed)="clearSelectedUsers()">
              Limpar seleção
            </app-button>
          </div>
        </ng-container>
        <ng-template #bulkEmpty>
          <span class="users-bulk-empty">Selecione usuários para ações em lote.</span>
        </ng-template>
      </div>

      <div class="users-table-wrap" (click)="closeUserRowMenu()">
        <div class="users-table-loading" *ngIf="loading || bulkUsersLoading">Atualizando usuários...</div>
        <table class="users-table">
          <thead>
            <tr>
              <th class="check-col">
                <input
                  type="checkbox"
                  [checked]="areAllFilteredUsersSelected()"
                  [indeterminate]="isPartialUsersSelection()"
                  (click)="$event.stopPropagation()"
                  (change)="toggleSelectAllFilteredUsers($any($event.target).checked)"
                  aria-label="Selecionar todos os usuários filtrados"
                />
              </th>
              <th>
                <button type="button" class="table-sort-btn" (click)="toggleUserSort('name')">
                  Nome {{ userSortIndicator('name') }}
                </button>
              </th>
              <th>
                <button type="button" class="table-sort-btn" (click)="toggleUserSort('email')">
                  E-mail {{ userSortIndicator('email') }}
                </button>
              </th>
              <th>
                <button type="button" class="table-sort-btn" (click)="toggleUserSort('status')">
                  Status {{ userSortIndicator('status') }}
                </button>
              </th>
              <th>Perfis</th>
              <th>
                <button type="button" class="table-sort-btn" (click)="toggleUserSort('createdAt')">
                  Criado {{ userSortIndicator('createdAt') }}
                </button>
              </th>
              <th>
                <button type="button" class="table-sort-btn" (click)="toggleUserSort('updatedAt')">
                  Atualizado {{ userSortIndicator('updatedAt') }}
                </button>
              </th>
              <th class="actions-col">Ações</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of filteredUsers(); trackBy: trackUser">
              <td class="check-col">
                <input
                  type="checkbox"
                  [checked]="isUserSelected(user.id)"
                  (click)="$event.stopPropagation()"
                  (change)="toggleUserSelection(user.id, $any($event.target).checked)"
                  [attr.aria-label]="'Selecionar usuário ' + user.email"
                />
              </td>
              <td>
                <div class="user-name">{{ user.name || '-' }} <span class="user-self-chip" *ngIf="isCurrentUser(user)">(você)</span></div>
              </td>
              <td>
                <div class="user-email">{{ user.email }}</div>
                <div class="meta user-id">ID: {{ user.id }}</div>
              </td>
              <td>
                <span class="status-chip" [class.inactive]="!user.active">
                  {{ user.active ? 'Ativo' : 'Inativo' }}
                </span>
              </td>
              <td>
                <div class="roles-inline">
                  <span class="role-chip" *ngFor="let role of user.roles">{{ role }}</span>
                </div>
              </td>
              <td>{{ user.createdAt | date : 'dd/MM/yyyy HH:mm' }}</td>
              <td>{{ user.updatedAt | date : 'dd/MM/yyyy HH:mm' }}</td>
              <td class="actions-col">
                <div class="table-actions">
                  <app-button size="sm" tone="neutral" variant="outline" (pressed)="openEditUserModal(user)">Editar</app-button>
                  <button type="button" class="row-menu-trigger" (click)="$event.stopPropagation(); toggleUserRowMenu(user.id)">⋯</button>
                  <div class="row-menu" *ngIf="isUserRowMenuOpen(user.id)" (click)="$event.stopPropagation()">
                    <button type="button" (click)="openPasswordModal(user)">Redefinir senha</button>
                    <button type="button" (click)="revokeRefreshTokens(user)">Revogar refresh</button>
                    <button type="button" *ngIf="!user.active" (click)="setUserActiveQuick(user, true)">Ativar usuário</button>
                    <button type="button" *ngIf="user.active" (click)="setUserActiveQuick(user, false)">Desativar usuário</button>
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card card-permissions" *ngIf="adminSection === 'PERMISSIONS'">
      <div class="permissions-layout">
        <aside class="permissions-roles">
          <div class="card-head">
            <h3>Perfis</h3>
            <app-button size="sm" tone="primary" variant="solid" (pressed)="startCreateRole()">Novo perfil</app-button>
          </div>
          <label class="field role-search">
            <span>Buscar perfil</span>
            <input
              type="text"
              [(ngModel)]="roleSearchTerm"
              [ngModelOptions]="{ standalone: true }"
              placeholder="Digite o nome do perfil"
            />
          </label>
          <div class="role-list">
            <button
              type="button"
              class="role-item"
              *ngFor="let role of filteredRoles(); trackBy: trackRole"
              [class.active]="sameRoleName(role.name, selectedRoleName)"
              [class.system]="isSystemRole(role.name)"
              (click)="selectRole(role.name)"
            >
              <span class="role-item__name">{{ role.name }}</span>
                <span class="role-item__meta">
                  <span class="perm-chip">{{ rolePermissionCount(role) }}</span>
                  <span class="role-system-chip" *ngIf="isSystemRole(role.name)">sistema</span>
                </span>
              </button>
            <div class="muted role-empty" *ngIf="!filteredRoles().length">Nenhum perfil encontrado.</div>
          </div>
        </aside>

        <div class="permissions-content">
          <div class="card-head">
            <div class="permissions-title-wrap">
              <h3 class="permissions-title">Permissões do perfil: {{ selectedRoleName || '-' }}</h3>
              <p class="permissions-subtitle" *ngIf="selectedRoleName">
                {{ selectedRolePermissionSummary() }}
              </p>
            </div>
            <div class="table-actions" *ngIf="selectedRoleName">
              <app-button
                size="sm"
                tone="primary"
                [variant]="hasAnyRoleChanges() ? 'solid' : 'outline'"
                [disabled]="savingAllRoleChanges || isSelectedAdminProfile() || !hasAnyRoleChanges()"
                (pressed)="saveAllRoleChanges()"
              >
                {{ savingAllRoleChanges ? 'Salvando...' : 'Salvar alterações' }}
              </app-button>
              <app-button
                size="sm"
                tone="neutral"
                variant="outline"
                [disabled]="isSystemRole(selectedRoleName)"
                (pressed)="startEditRole(selectedRoleName)"
              >
                Editar perfil
              </app-button>
              <app-button
                size="sm"
                tone="danger"
                variant="outline"
                [disabled]="isSystemRole(selectedRoleName)"
                (pressed)="deleteRole(selectedRoleName)"
              >
                Excluir perfil
              </app-button>
            </div>
          </div>

          <div class="role-editor" *ngIf="roleEditorOpen">
            <div class="role-editor-head">
              <strong>{{ roleEditorMode === 'create' ? 'Criar perfil' : 'Editar perfil' }}</strong>
              <app-button tone="neutral" variant="outline" (pressed)="cancelRoleEditor()">Cancelar</app-button>
            </div>

            <label class="field">
              <span>Nome do perfil</span>
              <input
                type="text"
                [(ngModel)]="roleForm.name"
                [ngModelOptions]="{ standalone: true }"
                placeholder="Ex.: ANALISTA"
              />
            </label>

            <div class="roles-picker">
              <span class="roles-label">Permissões</span>
              <div class="roles-picker-actions">
                <input
                  type="text"
                  [(ngModel)]="rolePermissionFilter"
                  [ngModelOptions]="{ standalone: true }"
                  placeholder="Filtrar permissões"
                />
                <app-button size="sm" tone="neutral" variant="outline" (pressed)="selectAllVisibleRolePermissions()">Marcar visíveis</app-button>
                <app-button size="sm" tone="neutral" variant="outline" (pressed)="clearAllRolePermissions()">Limpar</app-button>
              </div>
              <small class="roles-picker-meta">
                {{ roleForm.permissions.size }} selecionada(s) de {{ permissionsCatalog.length }}
              </small>
              <div class="permission-groups">
                <section class="permission-group" *ngFor="let group of groupedRoleEditorPermissions(); trackBy: trackPermissionGroup">
                  <div class="permission-group__title">{{ group.title }}</div>
                  <div class="roles-pick-list">
                    <label
                      class="check inline permission-option"
                      *ngFor="let permission of group.items; trackBy: trackPermissionCatalog"
                      [title]="permission.description || permission.code"
                    >
                      <input
                        type="checkbox"
                        [checked]="roleForm.permissions.has(permission.code)"
                        (change)="toggleRolePermission(permission.code, $any($event.target).checked)"
                      />
                      <span class="permission-option__text">
                        <span class="permission-option__label">{{ permission.label || permission.code }}</span>
                        <span class="permission-option__code">{{ permission.code }}</span>
                      </span>
                    </label>
                  </div>
                </section>
              </div>
            </div>

            <app-button tone="primary" variant="solid" [disabled]="roleSaving" (pressed)="saveRole()">
              {{ roleSaving ? 'Salvando...' : 'Salvar perfil' }}
            </app-button>
          </div>

          <div *ngIf="selectedRoleName">
            <div class="admin-profile-note" *ngIf="isSelectedAdminProfile()">
              Perfil <strong>ADMIN</strong>: acesso total definido no backend. Alterações de permissão/ACL ficam desabilitadas no frontend.
            </div>
            <div class="permission-block">
              <div class="card-head">
                <strong>Telas e ações</strong>
                <span class="dirty-chip" *ngIf="hasSelectedRolePermissionChanges()">Não salvo ({{ pendingRolePermissionChangesCount() }})</span>
              </div>
              <div class="permissions-filters">
                <label class="field">
                  <span>Buscar permissões</span>
                  <input
                    type="text"
                    [(ngModel)]="selectedPermissionSearchTerm"
                    [ngModelOptions]="{ standalone: true }"
                    placeholder="Buscar por nome, código ou descrição"
                  />
                </label>
                <div class="permissions-quick-filters">
                  <app-button size="sm" [tone]="selectedPermissionCategoryFilter === 'ALL' ? 'primary' : 'neutral'" [variant]="selectedPermissionCategoryFilter === 'ALL' ? 'solid' : 'outline'" (pressed)="setPermissionCategoryFilter('ALL')">Todas ({{ permissionCategorySelectedCount('ALL') }}/{{ permissionCategoryCount('ALL') }})</app-button>
                  <app-button size="sm" [tone]="selectedPermissionCategoryFilter === 'EMAIL' ? 'primary' : 'neutral'" [variant]="selectedPermissionCategoryFilter === 'EMAIL' ? 'solid' : 'outline'" (pressed)="setPermissionCategoryFilter('EMAIL')">Email ({{ permissionCategorySelectedCount('EMAIL') }}/{{ permissionCategoryCount('EMAIL') }})</app-button>
                  <app-button size="sm" [tone]="selectedPermissionCategoryFilter === 'REPORTS' ? 'primary' : 'neutral'" [variant]="selectedPermissionCategoryFilter === 'REPORTS' ? 'solid' : 'outline'" (pressed)="setPermissionCategoryFilter('REPORTS')">Relatórios ({{ permissionCategorySelectedCount('REPORTS') }}/{{ permissionCategoryCount('REPORTS') }})</app-button>
                  <app-button size="sm" [tone]="selectedPermissionCategoryFilter === 'TEMPLATES' ? 'primary' : 'neutral'" [variant]="selectedPermissionCategoryFilter === 'TEMPLATES' ? 'solid' : 'outline'" (pressed)="setPermissionCategoryFilter('TEMPLATES')">Templates ({{ permissionCategorySelectedCount('TEMPLATES') }}/{{ permissionCategoryCount('TEMPLATES') }})</app-button>
                  <app-button size="sm" [tone]="selectedPermissionCategoryFilter === 'FOLDERS' ? 'primary' : 'neutral'" [variant]="selectedPermissionCategoryFilter === 'FOLDERS' ? 'solid' : 'outline'" (pressed)="setPermissionCategoryFilter('FOLDERS')">Pastas ({{ permissionCategorySelectedCount('FOLDERS') }}/{{ permissionCategoryCount('FOLDERS') }})</app-button>
                  <app-button size="sm" [tone]="selectedPermissionCategoryFilter === 'SQL' ? 'primary' : 'neutral'" [variant]="selectedPermissionCategoryFilter === 'SQL' ? 'solid' : 'outline'" (pressed)="setPermissionCategoryFilter('SQL')">SQL ({{ permissionCategorySelectedCount('SQL') }}/{{ permissionCategoryCount('SQL') }})</app-button>
                  <app-button size="sm" [tone]="selectedPermissionCategoryFilter === 'SCHEDULES' ? 'primary' : 'neutral'" [variant]="selectedPermissionCategoryFilter === 'SCHEDULES' ? 'solid' : 'outline'" (pressed)="setPermissionCategoryFilter('SCHEDULES')">Agendamentos ({{ permissionCategorySelectedCount('SCHEDULES') }}/{{ permissionCategoryCount('SCHEDULES') }})</app-button>
                </div>
                <label class="check inline marked-toggle">
                  <input
                    type="checkbox"
                    [(ngModel)]="selectedPermissionOnlyMarked"
                    [ngModelOptions]="{ standalone: true }"
                  />
                  Somente marcadas
                </label>
              </div>
              <div class="permission-groups permission-groups--selected">
                <section class="permission-group" *ngFor="let group of groupedSelectedRolePermissions(); trackBy: trackPermissionGroup">
                  <div class="permission-group__head">
                    <div class="permission-group__title">{{ group.title }}</div>
                    <div class="permission-group__actions">
                      <button type="button" class="permission-group-action" [disabled]="isSelectedAdminProfile()" (click)="applyPermissionGroupSelection(group.items, 'all')">
                        Marcar tudo
                      </button>
                      <button type="button" class="permission-group-action" [disabled]="isSelectedAdminProfile()" (click)="applyPermissionGroupSelection(group.items, 'none')">
                        Desmarcar tudo
                      </button>
                    </div>
                  </div>
                  <div class="roles-pick-list">
                    <label
                      class="check inline permission-option"
                      *ngFor="let permission of group.items; trackBy: trackPermissionCatalog"
                      [title]="permission.description || permission.code"
                    >
                      <input
                        type="checkbox"
                        [checked]="isSelectedRolePermission(permission.code)"
                        [disabled]="isSelectedAdminProfile()"
                        (change)="setSelectedRolePermission(permission.code, $any($event.target).checked)"
                      />
                      <span class="permission-option__line">
                        <span class="permission-option__label">{{ permission.label || permission.code }}</span>
                        <span class="permission-option__code">{{ permission.code }}</span>
                      </span>
                    </label>
                  </div>
                </section>
              </div>
            </div>

            <div class="permission-block permission-block--acl">
              <div class="card-head">
                <strong>Pastas e relatórios</strong>
                <span class="dirty-chip" *ngIf="hasRoleAclChanges()">Não salvo ({{ pendingRoleAclChangesCount() }})</span>
                <div class="table-actions">
                  <app-button size="sm" tone="neutral" variant="outline" (pressed)="expandAllRoleAclFolders()">Expandir tudo</app-button>
                  <app-button size="sm" tone="neutral" variant="outline" (pressed)="collapseAllRoleAclFolders()">Recolher tudo</app-button>
                </div>
              </div>
              <label class="field acl-search-field">
                <span>Buscar pasta ou relatório</span>
                <input
                  type="text"
                  [(ngModel)]="roleAclSearchTerm"
                  [ngModelOptions]="{ standalone: true }"
                  placeholder="Digite para filtrar"
                />
              </label>
              <div class="acl-filter-actions">
                <app-button
                  size="sm"
                  [tone]="roleAclAccessFilter === 'ALLOW' ? 'primary' : 'neutral'"
                  [variant]="roleAclAccessFilter === 'ALLOW' ? 'solid' : 'outline'"
                  (pressed)="toggleRoleAclAccessFilter('ALLOW')"
                >
                  Com acesso
                </app-button>
                <app-button
                  size="sm"
                  [tone]="roleAclAccessFilter === 'DENY' ? 'danger' : 'neutral'"
                  [variant]="roleAclAccessFilter === 'DENY' ? 'solid' : 'outline'"
                  (pressed)="toggleRoleAclAccessFilter('DENY')"
                >
                  Sem acesso
                </app-button>
              </div>
              <div class="muted" *ngIf="aclTreeLoading">Carregando ACL do perfil...</div>
              <div class="acl-tree-editor" *ngIf="!aclTreeLoading">
                <div class="acl-tree-folder" *ngFor="let folderNode of filteredRoleAclTree(); trackBy: trackRoleAclFolder">
                  <div class="acl-tree-folder-head">
                    <button type="button" class="acl-tree-folder-toggle" (click)="toggleRoleAclFolder(folderNode.id)">
                      <span>{{ folderNode.expanded ? '▾' : '▸' }}</span>
                      <span class="acl-kind-chip acl-kind-chip--folder">PASTA</span>
                      <strong>{{ folderNode.name }}</strong>
                      <span class="perm-chip">{{ folderNode.reports.length }} relatório(s)</span>
                      <span class="perm-chip">
                        {{ allowedReportsCount(folderNode) }} com acesso / {{ deniedReportsCount(folderNode) }} sem
                      </span>
                    </button>

                    <div class="acl-tree-folder-controls">
                      <select
                        class="acl-simple-row__select acl-simple-row__select--sm"
                        [ngModel]="folderNode.allowed ? 'ALLOW' : 'DENY'"
                        [ngModelOptions]="{ standalone: true }"
                        [disabled]="isSelectedAdminProfile()"
                        (ngModelChange)="setFolderAclAllowed(folderNode.id, $event === 'ALLOW')"
                      >
                        <option value="ALLOW">Ver e executar</option>
                        <option value="DENY">Sem acesso</option>
                      </select>
                      <span class="perm-chip" [class.perm-chip--allowed]="customReportsCount(folderNode) === 0" [class.perm-chip--denied]="customReportsCount(folderNode) > 0">
                        {{ customReportsCount(folderNode) === 0 ? 'Herdado' : 'Custom' }}
                      </span>
                      <button
                        type="button"
                        class="acl-menu-trigger"
                        [disabled]="isSelectedAdminProfile()"
                        (click)="toggleFolderBulkMenu(folderNode.id)"
                      >
                        ⋯
                      </button>
                      <div class="acl-menu" *ngIf="isFolderBulkMenuOpen(folderNode.id)">
                        <button type="button" (click)="applyFolderPermissionToAllReports(folderNode.id)">Aplicar permissão a todos</button>
                        <button type="button" (click)="setAllFolderReportsNoAccess(folderNode.id)">Definir todos sem acesso</button>
                        <button type="button" (click)="inheritAllFolderReports(folderNode.id)">Herdar todos</button>
                      </div>
                    </div>
                  </div>

                  <div class="acl-tree-folder-body" *ngIf="folderNode.expanded">
                    <div class="acl-tree-reports">
                      <div class="acl-tree-report" [class.acl-tree-report--exception]="isReportAclException(folderNode, reportNode)" *ngFor="let reportNode of folderNode.reports; trackBy: trackRoleAclReport">
                        <div class="acl-tree-report-line">
                          <div class="acl-tree-report-title">
                            <span class="acl-kind-chip acl-kind-chip--report">REL</span>
                            <span>{{ reportNode.name }}</span>
                          </div>
                          <div class="acl-tree-report-controls">
                            <span class="perm-chip" [class.perm-chip--allowed]="reportNode.useFolderInheritance" [class.perm-chip--denied]="!reportNode.useFolderInheritance">
                              {{ reportNode.useFolderInheritance ? 'Herdado' : 'Custom' }}
                            </span>
                            <span class="perm-chip perm-chip--warning" *ngIf="isReportAclException(folderNode, reportNode)" title="Exceção: relatório com regra diferente da pasta">
                              Exceção
                            </span>
                            <select
                              class="acl-simple-row__select acl-simple-row__select--sm"
                              [class.acl-simple-row__select--inherited]="reportNode.useFolderInheritance"
                              [ngModel]="reportNode.allowed ? 'ALLOW' : 'DENY'"
                              [ngModelOptions]="{ standalone: true }"
                              [disabled]="isSelectedAdminProfile()"
                              [title]="reportNode.useFolderInheritance ? 'Herdado da pasta: ao alterar vira personalizado' : 'Permissão customizada'"
                              (ngModelChange)="setReportAclAllowed(folderNode.id, reportNode.id, $event === 'ALLOW')"
                            >
                              <option value="ALLOW">Ver e executar</option>
                              <option value="DENY">Sem acesso</option>
                            </select>
                            <button
                              type="button"
                              class="acl-link-action"
                              [title]="reportNode.useFolderInheritance ? 'Customizar permissão do relatório' : 'Reverter para herança da pasta'"
                              [disabled]="isSelectedAdminProfile()"
                              (click)="reportNode.useFolderInheritance ? customizeReportAcl(folderNode.id, reportNode.id) : inheritReportAclFromFolder(folderNode.id, reportNode.id)"
                            >
                              {{ reportNode.useFolderInheritance ? '✎' : '↺' }}
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="muted" *ngIf="!selectedRoleName">Crie um perfil ou selecione um perfil para editar permissões e ACL.</div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" *ngIf="createUserModalOpen" (click)="closeCreateUserModal()"></div>
  <div class="modal-card" *ngIf="createUserModalOpen">
    <div class="card-head">
      <h3>Criar usuário</h3>
      <app-button tone="neutral" variant="outline" (pressed)="closeCreateUserModal()">Fechar</app-button>
    </div>
    <div class="status-row modal-status-row">
      <div class="status error" *ngIf="error">{{ error }}</div>
      <div class="status ok" *ngIf="status">{{ status }}</div>
    </div>

    <div class="create-form">
      <label class="field">
        <span>Nome</span>
        <input type="text" [(ngModel)]="createForm.name" [ngModelOptions]="{ standalone: true }" placeholder="Nome completo" />
      </label>

      <label class="field">
        <span>E-mail</span>
        <input type="email" [(ngModel)]="createForm.email" [ngModelOptions]="{ standalone: true }" placeholder="usuario@empresa.com" />
      </label>

      <label class="field">
        <span>Senha</span>
        <input type="password" [(ngModel)]="createForm.password" [ngModelOptions]="{ standalone: true }" placeholder="Mínimo 6 caracteres" />
      </label>

      <label class="check">
        <input type="checkbox" [(ngModel)]="createForm.active" [ngModelOptions]="{ standalone: true }" />
        Ativo
      </label>

      <div class="roles-picker">
        <span class="roles-label">Perfis iniciais</span>
        <app-reports-multi-select
          [options]="createUserRoleOptions()"
          [selectedValues]="createUserSelectedRoles()"
          [placeholder]="'Selecione os perfis (obrigatório)'"
          (selectedValuesChange)="onCreateUserRolesChange($event)"
        ></app-reports-multi-select>
      </div>

      <app-button tone="primary" variant="solid" (pressed)="createUser()" [disabled]="saving || !canSubmitCreateUser()">
        {{ saving ? 'Criando...' : 'Criar usuário' }}
      </app-button>
    </div>
  </div>

  <div class="modal-backdrop" *ngIf="editUserModalOpen" (click)="closeEditUserModal()"></div>
  <div class="modal-card" *ngIf="editUserModalOpen && editUserDraft">
    <div class="card-head">
      <h3>Editar usuário</h3>
      <app-button tone="neutral" variant="outline" (pressed)="closeEditUserModal()">Fechar</app-button>
    </div>
    <div class="status-row modal-status-row">
      <div class="status error" *ngIf="error">{{ error }}</div>
      <div class="status ok" *ngIf="status">{{ status }}</div>
    </div>

    <div class="create-form">
      <label class="field">
        <span>Nome</span>
        <input type="text" [(ngModel)]="editUserDraft.name" [ngModelOptions]="{ standalone: true }" />
      </label>

      <label class="field">
        <span>E-mail</span>
        <input type="text" [value]="editUserDraft.email" disabled />
      </label>

      <label class="check">
        <input type="checkbox" [(ngModel)]="editUserDraft.active" [ngModelOptions]="{ standalone: true }" />
        Ativo
      </label>

      <div class="roles-picker">
        <span class="roles-label">Perfis</span>
        <app-reports-multi-select
          [options]="createUserRoleOptions()"
          [selectedValues]="editUserRoleSelection"
          [placeholder]="'Selecione os perfis'"
          (selectedValuesChange)="onEditUserRolesChange($event)"
        ></app-reports-multi-select>
      </div>

      <app-button tone="primary" variant="solid" (pressed)="saveEditUser()" [disabled]="editUserSaving">
        {{ editUserSaving ? 'Salvando...' : 'Salvar alterações' }}
      </app-button>
    </div>
  </div>

  <div class="modal-backdrop" *ngIf="passwordModalOpen" (click)="closePasswordModal()"></div>
  <div class="modal-card modal-card--sm" *ngIf="passwordModalOpen && passwordModalUser">
    <div class="card-head">
      <h3>Redefinir senha</h3>
      <app-button tone="neutral" variant="outline" (pressed)="closePasswordModal()">Fechar</app-button>
    </div>
    <div class="status-row modal-status-row">
      <div class="status error" *ngIf="error">{{ error }}</div>
      <div class="status ok" *ngIf="status">{{ status }}</div>
    </div>
    <div class="create-form">
      <div class="meta">{{ passwordModalUser.email }}</div>
      <label class="field">
        <span>Nova senha</span>
        <input
          type="password"
          [(ngModel)]="passwordModalValue"
          [ngModelOptions]="{ standalone: true }"
          placeholder="Mínimo 6 caracteres"
          autocomplete="new-password"
        />
      </label>
      <app-button tone="primary" variant="solid" (pressed)="submitPasswordReset()" [disabled]="passwordModalSaving">
        {{ passwordModalSaving ? 'Salvando...' : 'Redefinir senha' }}
      </app-button>
    </div>
  </div>
</section>
