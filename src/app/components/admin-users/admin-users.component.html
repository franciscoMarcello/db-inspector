<section class="admin-shell">
  <div class="admin-grid">
    <div class="card card-header">
      <div class="card-head">
        <div>
          <h2>Usuários</h2>
          <p class="muted">Gerencie criação, ativação e permissões de acesso.</p>
        </div>
        <button type="button" class="btn primary" (click)="openCreateUserModal()">Criar usuário</button>
      </div>
      <div class="status-row">
        <div class="status error" *ngIf="error">{{ error }}</div>
        <div class="status ok" *ngIf="status">{{ status }}</div>
      </div>
    </div>

    <div class="card card-users">
      <div class="card-head">
        <h3>Lista de usuários</h3>
        <button type="button" class="btn" (click)="loadAll()" [disabled]="loading">
          {{ loading ? 'Atualizando...' : 'Atualizar' }}
        </button>
      </div>

      <div class="users-table-wrap">
        <table class="users-table">
          <thead>
            <tr>
              <th>E-mail</th>
              <th>Status</th>
              <th>Roles</th>
              <th>Criado</th>
              <th>Atualizado</th>
              <th class="actions-col">Ações</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of users; trackBy: trackUser">
              <td>
                <div class="user-email">{{ user.email }}</div>
                <div class="meta">ID: {{ user.id }}</div>
              </td>
              <td>
                <span class="status-chip" [class.inactive]="!user.active">
                  {{ user.active ? 'Ativo' : 'Inativo' }}
                </span>
              </td>
              <td>
                <div class="roles-inline">
                  <span class="role-chip" *ngFor="let role of user.roles">{{ role }}</span>
                </div>
              </td>
              <td>{{ user.createdAt | date : 'dd/MM/yyyy HH:mm' }}</td>
              <td>{{ user.updatedAt | date : 'dd/MM/yyyy HH:mm' }}</td>
              <td class="actions-col">
                <div class="table-actions">
                  <button type="button" class="btn btn-sm" (click)="openEditUserModal(user)">Editar</button>
                  <button type="button" class="btn btn-sm" (click)="openPasswordModal(user)">Redefinir senha</button>
                  <button type="button" class="btn btn-sm" (click)="revokeRefreshTokens(user)">
                    Revogar refresh
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card card-roles">
      <div class="card-head">
        <h3>Roles</h3>
        <button type="button" class="btn primary" (click)="startCreateRole()">Nova role</button>
      </div>

      <div class="role-editor" *ngIf="roleEditorOpen">
        <div class="role-editor-head">
          <strong>{{ roleEditorMode === 'create' ? 'Criar role' : 'Editar role' }}</strong>
          <button type="button" class="btn" (click)="cancelRoleEditor()">Cancelar</button>
        </div>

        <label class="field">
          <span>Nome da role</span>
          <input
            type="text"
            [(ngModel)]="roleForm.name"
            [ngModelOptions]="{ standalone: true }"
            placeholder="Ex.: ANALISTA"
          />
        </label>

        <div class="roles-picker">
          <span class="roles-label">Permissões</span>
          <div class="roles-picker-actions">
            <input
              type="text"
              [(ngModel)]="rolePermissionFilter"
              [ngModelOptions]="{ standalone: true }"
              placeholder="Filtrar permissões"
            />
            <button type="button" class="btn btn-sm" (click)="selectAllVisibleRolePermissions()">Marcar visíveis</button>
            <button type="button" class="btn btn-sm" (click)="clearAllRolePermissions()">Limpar</button>
          </div>
          <small class="roles-picker-meta">
            {{ roleForm.permissions.size }} selecionada(s) de {{ permissionsCatalog.length }}
          </small>
          <div class="roles-pick-list">
            <label
              class="check inline permission-option"
              *ngFor="let permission of filteredPermissionsCatalog(); trackBy: trackPermissionCatalog"
              [title]="permission.description || permission.code"
            >
              <input
                type="checkbox"
                [checked]="roleForm.permissions.has(permission.code)"
                (change)="toggleRolePermission(permission.code, $any($event.target).checked)"
              />
              <span class="permission-option__text">
                <span class="permission-option__label">{{ permission.label || permission.code }}</span>
                <span class="permission-option__code">{{ permission.code }}</span>
              </span>
            </label>
          </div>
        </div>

        <button type="button" class="btn primary" [disabled]="roleSaving" (click)="saveRole()">
          {{ roleSaving ? 'Salvando...' : 'Salvar role' }}
        </button>
      </div>

      <div class="roles-def-list">
        <div class="role-def" *ngFor="let role of roles; trackBy: trackRole">
          <div class="role-def-head">
            <strong>{{ role.name }}</strong>
            <div class="role-def-actions">
              <button type="button" class="btn btn-sm" (click)="startEditRole(role.name)">Editar</button>
              <button
                type="button"
                class="btn btn-sm danger"
                [disabled]="isSystemRole(role.name)"
                (click)="deleteRole(role.name)"
              >
                Excluir
              </button>
            </div>
          </div>
          <div class="perm-list">
            <span
              class="perm-chip"
              *ngFor="let perm of role.permissions"
              [title]="permissionDescription(perm) || perm"
            >
              {{ permissionLabel(perm) }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <div class="card card-acl">
      <div class="card-head">
        <h3>ACL de pastas e relatórios</h3>
        <button type="button" class="btn" (click)="refreshAclRules()" [disabled]="aclLoading">
          {{ aclLoading ? 'Carregando...' : 'Atualizar ACL' }}
        </button>
      </div>

      <div class="acl-subject-view">
        <div class="card-head">
          <strong>Visualizar ACL por usuário/role</strong>
          <div class="table-actions">
            <button type="button" class="btn btn-sm" (click)="clearAclSubjectView()">Limpar</button>
            <button type="button" class="btn btn-sm" (click)="loadAclSubjectView()" [disabled]="aclSubjectViewLoading">
              {{ aclSubjectViewLoading ? 'Carregando...' : 'Carregar visão' }}
            </button>
          </div>
        </div>

        <div class="acl-grid">
          <label class="field">
            <span>Tipo</span>
            <select
              [ngModel]="aclSubjectViewType"
              [ngModelOptions]="{ standalone: true }"
              (ngModelChange)="onAclSubjectViewTypeChange($event)"
            >
              <option value="ROLE">ROLE</option>
              <option value="USER">USER</option>
            </select>
          </label>

          <ng-container *ngIf="aclSubjectViewType === 'ROLE'; else aclUserViewPicker">
            <label class="field">
              <span>Role</span>
              <select
                [ngModel]="aclSubjectView"
                [ngModelOptions]="{ standalone: true }"
                (ngModelChange)="aclSubjectView = $event"
              >
                <option value="">Selecione uma role</option>
                <option *ngFor="let role of roles; trackBy: trackRole" [value]="role.name">{{ role.name }}</option>
              </select>
            </label>
          </ng-container>
          <ng-template #aclUserViewPicker>
            <label class="field">
              <span>Usuário</span>
              <select
                [ngModel]="aclSubjectView"
                [ngModelOptions]="{ standalone: true }"
                (ngModelChange)="aclSubjectView = $event"
              >
                <option value="">Selecione um usuário</option>
                <option *ngFor="let user of users; trackBy: trackUser" [value]="user.id">
                  {{ user.email }} ({{ user.id }})
                </option>
              </select>
            </label>
          </ng-template>
        </div>

        <div class="acl-subject-tree">
          <div class="muted" *ngIf="!aclSubjectTree.length && !aclSubjectViewLoading">
            Sem regras para o filtro selecionado.
          </div>

          <div class="acl-tree-folder" *ngFor="let folderNode of aclSubjectTree; trackBy: trackAclSubjectFolder">
            <button type="button" class="acl-tree-folder-head" (click)="toggleAclSubjectFolder(folderNode.folderId)">
              <span>{{ isAclSubjectFolderExpanded(folderNode.folderId) ? '▾' : '▸' }}</span>
              <strong>{{ folderNode.folderName }}</strong>
              <span class="perm-chip">{{ folderNode.folderRules.length }} regra(s) na pasta</span>
              <span class="perm-chip">{{ folderNode.reports.length }} relatório(s)</span>
            </button>

            <div class="acl-tree-folder-body" *ngIf="isAclSubjectFolderExpanded(folderNode.folderId)">
              <div class="acl-tree-rules" *ngIf="folderNode.folderRules.length">
                <div class="acl-row" *ngFor="let rule of folderNode.folderRules; trackBy: trackAclRule">
                  <div class="acl-row__main">
                    <strong class="acl-subject-type">{{ rule.subjectType }}</strong>
                    <span>{{ rule.subject }}</span>
                  </div>
                  <div class="acl-perm-stack">
                    <div class="acl-perm-line">
                      <span class="acl-perm-label">Visualizar</span>
                      <span class="acl-perm-value" [class.denied]="!rule.canView">{{ rule.canView ? 'Sim' : 'Não' }}</span>
                    </div>
                    <div class="acl-perm-line">
                      <span class="acl-perm-label">Executar</span>
                      <span class="acl-perm-value" [class.denied]="!rule.canRun">{{ rule.canRun ? 'Sim' : 'Não' }}</span>
                    </div>
                    <div class="acl-perm-line">
                      <span class="acl-perm-label">Editar</span>
                      <span class="acl-perm-value" [class.denied]="!rule.canEdit">{{ rule.canEdit ? 'Sim' : 'Não' }}</span>
                    </div>
                    <div class="acl-perm-line">
                      <span class="acl-perm-label">Excluir</span>
                      <span class="acl-perm-value" [class.denied]="!rule.canDelete">{{ rule.canDelete ? 'Sim' : 'Não' }}</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="muted" *ngIf="!folderNode.folderRules.length">
                Sem regra explícita na pasta.
              </div>
              <div class="muted" *ngIf="!folderNode.folderRules.length && !folderNode.reports.length">
                Sem regras neste grupo.
              </div>

              <div class="acl-tree-report" *ngFor="let reportNode of folderNode.reports; trackBy: trackAclSubjectReport">
                <div class="acl-tree-report-title">{{ reportNode.reportName }}</div>
                <div class="acl-row" *ngFor="let rule of reportNode.rules; trackBy: trackAclRule">
                  <div class="acl-row__main">
                    <strong class="acl-subject-type">{{ rule.subjectType }}</strong>
                    <span>{{ rule.subject }}</span>
                  </div>
                  <div class="acl-perm-stack">
                    <div class="acl-perm-line">
                      <span class="acl-perm-label">Visualizar</span>
                      <span class="acl-perm-value" [class.denied]="!rule.canView">{{ rule.canView ? 'Sim' : 'Não' }}</span>
                    </div>
                    <div class="acl-perm-line">
                      <span class="acl-perm-label">Executar</span>
                      <span class="acl-perm-value" [class.denied]="!rule.canRun">{{ rule.canRun ? 'Sim' : 'Não' }}</span>
                    </div>
                    <div class="acl-perm-line">
                      <span class="acl-perm-label">Editar</span>
                      <span class="acl-perm-value" [class.denied]="!rule.canEdit">{{ rule.canEdit ? 'Sim' : 'Não' }}</span>
                    </div>
                    <div class="acl-perm-line">
                      <span class="acl-perm-label">Excluir</span>
                      <span class="acl-perm-value" [class.denied]="!rule.canDelete">{{ rule.canDelete ? 'Sim' : 'Não' }}</span>
                    </div>
                  </div>
                </div>
                <div class="muted" *ngIf="!reportNode.rules.length">
                  Sem regra explícita no relatório (usa regra da pasta, se existir).
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="acl-subject-list" *ngIf="aclSubjectRows.length">
          <strong>Regras consolidadas</strong>
          <div class="acl-subject-list-wrap">
            <table class="acl-subject-table">
              <thead>
                <tr>
                  <th>Tipo</th>
                  <th>Pasta</th>
                  <th>Alvo</th>
                  <th>Visualizar</th>
                  <th>Executar</th>
                  <th>Editar</th>
                  <th>Excluir</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let row of aclSubjectRows">
                  <td>{{ row.targetType === 'FOLDER' ? 'Pasta' : 'Relatório' }}</td>
                  <td>{{ row.folderName }}</td>
                  <td>{{ row.targetName }}</td>
                  <td>{{ row.rule.canView ? 'Sim' : 'Não' }}</td>
                  <td>{{ row.rule.canRun ? 'Sim' : 'Não' }}</td>
                  <td>{{ row.rule.canEdit ? 'Sim' : 'Não' }}</td>
                  <td>{{ row.rule.canDelete ? 'Sim' : 'Não' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="acl-grid">
        <label class="field">
          <span>Tipo de alvo</span>
          <select
            [ngModel]="aclEntityType"
            [ngModelOptions]="{ standalone: true }"
            (ngModelChange)="onAclEntityTypeChange($event)"
          >
            <option value="FOLDER">Pasta</option>
            <option value="REPORT">Relatório</option>
          </select>
        </label>

        <label class="field">
          <span>Alvo</span>
          <select
            [ngModel]="aclTargetId"
            [ngModelOptions]="{ standalone: true }"
            (ngModelChange)="onAclTargetChange($event)"
          >
            <option value="">Selecione</option>
            <ng-container *ngIf="aclEntityType === 'FOLDER'; else reportAclTargets">
              <option *ngFor="let folder of aclFolders" [value]="folder.id">
                {{ folder.name }}
              </option>
            </ng-container>
            <ng-template #reportAclTargets>
              <option *ngFor="let report of aclReports" [value]="report.id">
                {{ report.name }}
              </option>
            </ng-template>
          </select>
        </label>
      </div>

      <div class="acl-editor">
        <label class="field">
          <span>Subject Type</span>
          <select
            [ngModel]="aclDraft.subjectType"
            [ngModelOptions]="{ standalone: true }"
            (ngModelChange)="onAclSubjectTypeChange($event)"
          >
            <option value="ROLE">ROLE</option>
            <option value="USER">USER</option>
          </select>
        </label>

        <ng-container *ngIf="aclDraft.subjectType === 'ROLE'; else aclUserSubject">
          <label class="field">
            <span>Role</span>
            <select
              [ngModel]="aclDraft.subject"
              [ngModelOptions]="{ standalone: true }"
              (ngModelChange)="onAclDraftFieldChange('subject', $event)"
            >
              <option value="">Selecione uma role</option>
              <option *ngFor="let role of roles; trackBy: trackRole" [value]="role.name">
                {{ role.name }}
              </option>
            </select>
          </label>
        </ng-container>
        <ng-template #aclUserSubject>
          <label class="field">
            <span>Usuário (UUID)</span>
            <input
              type="text"
              [ngModel]="aclDraft.subject"
              [ngModelOptions]="{ standalone: true }"
              (ngModelChange)="onAclDraftFieldChange('subject', $event)"
              placeholder="uuid do usuário"
            />
          </label>
        </ng-template>

        <div class="acl-flags">
          <label class="check acl-flag">
            <input
              type="checkbox"
              [ngModel]="aclDraft.canView"
              [ngModelOptions]="{ standalone: true }"
              (ngModelChange)="onAclDraftFieldChange('canView', $event)"
            />
            Pode visualizar
          </label>
          <label class="check acl-flag">
            <input
              type="checkbox"
              [ngModel]="aclDraft.canRun"
              [ngModelOptions]="{ standalone: true }"
              (ngModelChange)="onAclDraftFieldChange('canRun', $event)"
            />
            Pode executar
          </label>
          <label class="check acl-flag">
            <input
              type="checkbox"
              [ngModel]="aclDraft.canEdit"
              [ngModelOptions]="{ standalone: true }"
              (ngModelChange)="onAclDraftFieldChange('canEdit', $event)"
            />
            Pode editar
          </label>
          <label class="check acl-flag">
            <input
              type="checkbox"
              [ngModel]="aclDraft.canDelete"
              [ngModelOptions]="{ standalone: true }"
              (ngModelChange)="onAclDraftFieldChange('canDelete', $event)"
            />
            Pode excluir
          </label>
        </div>

        <button type="button" class="btn primary" (click)="saveAclRule()" [disabled]="aclSaving || !aclTargetId">
          {{ aclSaving ? 'Salvando...' : 'Salvar regra ACL' }}
        </button>
      </div>

      <div class="acl-list">
        <div class="muted" *ngIf="!aclTargetId">Selecione um alvo para visualizar ACL.</div>
        <div class="muted" *ngIf="aclTargetId && aclLoading">Carregando regras ACL...</div>
        <div class="muted" *ngIf="aclTargetId && !aclLoading && !aclRules.length">Sem regras ACL cadastradas.</div>

        <div class="acl-row" *ngFor="let rule of aclRules; trackBy: trackAclRule">
          <div class="acl-row__main">
            <strong class="acl-subject-type">{{ rule.subjectType }}</strong>
            <span>{{ rule.subject }}</span>
          </div>
          <div class="acl-row__flags">
            <span class="perm-chip">view: {{ rule.canView ? 'sim' : 'não' }}</span>
            <span class="perm-chip">run: {{ rule.canRun ? 'sim' : 'não' }}</span>
            <span class="perm-chip">edit: {{ rule.canEdit ? 'sim' : 'não' }}</span>
            <span class="perm-chip">delete: {{ rule.canDelete ? 'sim' : 'não' }}</span>
          </div>
          <button type="button" class="btn btn-sm danger" (click)="removeAclRule(rule)">
            Remover
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" *ngIf="createUserModalOpen" (click)="closeCreateUserModal()"></div>
  <div class="modal-card" *ngIf="createUserModalOpen">
    <div class="card-head">
      <h3>Criar usuário</h3>
      <button type="button" class="btn" (click)="closeCreateUserModal()">Fechar</button>
    </div>

    <div class="create-form">
      <label class="field">
        <span>E-mail</span>
        <input type="email" [(ngModel)]="createForm.email" [ngModelOptions]="{ standalone: true }" placeholder="usuario@empresa.com" />
      </label>

      <label class="field">
        <span>Senha</span>
        <input type="password" [(ngModel)]="createForm.password" [ngModelOptions]="{ standalone: true }" placeholder="Mínimo 6 caracteres" />
      </label>

      <label class="check">
        <input type="checkbox" [(ngModel)]="createForm.active" [ngModelOptions]="{ standalone: true }" />
        Ativo
      </label>

      <div class="roles-picker">
        <span class="roles-label">Roles iniciais</span>
        <app-reports-multi-select
          [options]="createUserRoleOptions()"
          [selectedValues]="createUserSelectedRoles()"
          [placeholder]="'Selecione as roles'"
          (selectedValuesChange)="onCreateUserRolesChange($event)"
        ></app-reports-multi-select>
      </div>

      <button type="button" class="btn primary" (click)="createUser()" [disabled]="saving">
        {{ saving ? 'Criando...' : 'Criar usuário' }}
      </button>
    </div>
  </div>

  <div class="modal-backdrop" *ngIf="editUserModalOpen" (click)="closeEditUserModal()"></div>
  <div class="modal-card" *ngIf="editUserModalOpen && editUserDraft">
    <div class="card-head">
      <h3>Editar usuário</h3>
      <button type="button" class="btn" (click)="closeEditUserModal()">Fechar</button>
    </div>

    <div class="create-form">
      <label class="field">
        <span>E-mail</span>
        <input type="text" [value]="editUserDraft.email" disabled />
      </label>

      <label class="check">
        <input type="checkbox" [(ngModel)]="editUserDraft.active" [ngModelOptions]="{ standalone: true }" />
        Ativo
      </label>

      <div class="roles-picker">
        <span class="roles-label">Roles</span>
        <app-reports-multi-select
          [options]="createUserRoleOptions()"
          [selectedValues]="editUserSelectedRoles()"
          [placeholder]="'Selecione as roles'"
          (selectedValuesChange)="onEditUserRolesChange($event)"
        ></app-reports-multi-select>
      </div>

      <button type="button" class="btn primary" (click)="saveEditUser()" [disabled]="editUserSaving">
        {{ editUserSaving ? 'Salvando...' : 'Salvar alterações' }}
      </button>
    </div>
  </div>

  <div class="modal-backdrop" *ngIf="passwordModalOpen" (click)="closePasswordModal()"></div>
  <div class="modal-card modal-card--sm" *ngIf="passwordModalOpen && passwordModalUser">
    <div class="card-head">
      <h3>Redefinir senha</h3>
      <button type="button" class="btn" (click)="closePasswordModal()">Fechar</button>
    </div>
    <div class="create-form">
      <div class="meta">{{ passwordModalUser.email }}</div>
      <label class="field">
        <span>Nova senha</span>
        <input
          type="password"
          [(ngModel)]="passwordModalValue"
          [ngModelOptions]="{ standalone: true }"
          placeholder="Mínimo 6 caracteres"
          autocomplete="new-password"
        />
      </label>
      <button type="button" class="btn primary" (click)="submitPasswordReset()" [disabled]="passwordModalSaving">
        {{ passwordModalSaving ? 'Salvando...' : 'Redefinir senha' }}
      </button>
    </div>
  </div>
</section>
