<section class="admin-shell">
  <div class="admin-grid">
    <div class="card card-header">
      <div class="card-head">
        <div>
          <h2>{{ adminSection === 'USERS' ? 'Usuários' : 'Permissões' }}</h2>
          <p class="muted">
            {{ adminSection === 'USERS'
              ? 'Gerencie criação, ativação e permissões de acesso.'
              : 'Gerencie perfis e regras ACL de pastas e relatórios.' }}
          </p>
        </div>
        <app-button *ngIf="adminSection === 'USERS'" tone="primary" variant="solid" (pressed)="openCreateUserModal()">
          Criar usuário
        </app-button>
      </div>
      <div class="status-row">
        <div class="status error" *ngIf="error && !anyModalOpen">{{ error }}</div>
        <div class="status ok" *ngIf="status && !anyModalOpen">{{ status }}</div>
      </div>
    </div>

    <div class="card card-users" *ngIf="adminSection === 'USERS'">
      <div class="card-head">
        <h3>Lista de usuários</h3>
        <app-button tone="neutral" variant="outline" (pressed)="loadAll()" [disabled]="loading">
          {{ loading ? 'Atualizando...' : 'Atualizar' }}
        </app-button>
      </div>

      <div class="users-table-wrap">
        <table class="users-table">
          <thead>
            <tr>
              <th>Nome</th>
              <th>E-mail</th>
              <th>Status</th>
              <th>Perfis</th>
              <th>Criado</th>
              <th>Atualizado</th>
              <th class="actions-col">Ações</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of users; trackBy: trackUser">
              <td>
                <div class="user-name">{{ user.name || '-' }}</div>
              </td>
              <td>
                <div class="user-email">{{ user.email }}</div>
                <div class="meta">ID: {{ user.id }}</div>
              </td>
              <td>
                <span class="status-chip" [class.inactive]="!user.active">
                  {{ user.active ? 'Ativo' : 'Inativo' }}
                </span>
              </td>
              <td>
                <div class="roles-inline">
                  <span class="role-chip" *ngFor="let role of user.roles">{{ role }}</span>
                </div>
              </td>
              <td>{{ user.createdAt | date : 'dd/MM/yyyy HH:mm' }}</td>
              <td>{{ user.updatedAt | date : 'dd/MM/yyyy HH:mm' }}</td>
              <td class="actions-col">
                <div class="table-actions">
                  <app-button size="sm" tone="neutral" variant="outline" (pressed)="openEditUserModal(user)">Editar</app-button>
                  <app-button size="sm" tone="neutral" variant="outline" (pressed)="openPasswordModal(user)">Redefinir senha</app-button>
                  <app-button size="sm" tone="neutral" variant="outline" (pressed)="revokeRefreshTokens(user)">
                    Revogar refresh
                  </app-button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card card-permissions" *ngIf="adminSection === 'PERMISSIONS'">
      <div class="permissions-layout">
        <aside class="permissions-roles">
          <div class="card-head">
            <h3>Perfis</h3>
            <app-button size="sm" tone="primary" variant="solid" (pressed)="startCreateRole()">Novo perfil</app-button>
          </div>
          <div class="role-list">
            <button
              type="button"
              class="role-item"
              *ngFor="let role of roles; trackBy: trackRole"
              [class.active]="sameRoleName(role.name, selectedRoleName)"
              [class.system]="isSystemRole(role.name)"
              (click)="selectRole(role.name)"
            >
              <span>{{ role.name }}</span>
              <span class="role-system-chip" *ngIf="isSystemRole(role.name)">sistema</span>
            </button>
          </div>
        </aside>

        <div class="permissions-content">
          <div class="card-head">
            <h3>Permissões do perfil: {{ selectedRoleName || '-' }}</h3>
            <div class="table-actions" *ngIf="selectedRoleName">
              <app-button
                size="sm"
                tone="neutral"
                variant="outline"
                [disabled]="isSystemRole(selectedRoleName)"
                (pressed)="startEditRole(selectedRoleName)"
              >
                Editar perfil
              </app-button>
              <app-button
                size="sm"
                tone="danger"
                variant="outline"
                [disabled]="isSystemRole(selectedRoleName)"
                (pressed)="deleteRole(selectedRoleName)"
              >
                Excluir perfil
              </app-button>
            </div>
          </div>

          <div class="role-editor" *ngIf="roleEditorOpen">
            <div class="role-editor-head">
              <strong>{{ roleEditorMode === 'create' ? 'Criar perfil' : 'Editar perfil' }}</strong>
              <app-button tone="neutral" variant="outline" (pressed)="cancelRoleEditor()">Cancelar</app-button>
            </div>

            <label class="field">
              <span>Nome do perfil</span>
              <input
                type="text"
                [(ngModel)]="roleForm.name"
                [ngModelOptions]="{ standalone: true }"
                placeholder="Ex.: ANALISTA"
              />
            </label>

            <div class="roles-picker">
              <span class="roles-label">Permissões</span>
              <div class="roles-picker-actions">
                <input
                  type="text"
                  [(ngModel)]="rolePermissionFilter"
                  [ngModelOptions]="{ standalone: true }"
                  placeholder="Filtrar permissões"
                />
                <app-button size="sm" tone="neutral" variant="outline" (pressed)="selectAllVisibleRolePermissions()">Marcar visíveis</app-button>
                <app-button size="sm" tone="neutral" variant="outline" (pressed)="clearAllRolePermissions()">Limpar</app-button>
              </div>
              <small class="roles-picker-meta">
                {{ roleForm.permissions.size }} selecionada(s) de {{ permissionsCatalog.length }}
              </small>
              <div class="roles-pick-list">
                <label
                  class="check inline permission-option"
                  *ngFor="let permission of filteredPermissionsCatalog(); trackBy: trackPermissionCatalog"
                  [title]="permission.description || permission.code"
                >
                  <input
                    type="checkbox"
                    [checked]="roleForm.permissions.has(permission.code)"
                    (change)="toggleRolePermission(permission.code, $any($event.target).checked)"
                  />
                  <span class="permission-option__text">
                    <span class="permission-option__label">{{ permission.label || permission.code }}</span>
                    <span class="permission-option__code">{{ permission.code }}</span>
                  </span>
                </label>
              </div>
            </div>

            <app-button tone="primary" variant="solid" [disabled]="roleSaving" (pressed)="saveRole()">
              {{ roleSaving ? 'Salvando...' : 'Salvar perfil' }}
            </app-button>
          </div>

          <ng-container *ngIf="selectedRoleName">
            <div class="admin-profile-note" *ngIf="isSelectedAdminProfile()">
              Perfil <strong>ADMIN</strong>: acesso total definido no backend. Alterações de permissão/ACL ficam desabilitadas no frontend.
            </div>
            <div class="permission-block">
              <div class="card-head">
                <strong>Telas e ações</strong>
                <app-button
                  size="sm"
                  tone="primary"
                  variant="solid"
                  [disabled]="rolePermissionsSaving || isSelectedAdminProfile()"
                  (pressed)="saveSelectedRolePermissions()"
                >
                  {{ rolePermissionsSaving ? 'Salvando...' : 'Salvar permissões de telas' }}
                </app-button>
              </div>
              <div class="roles-pick-list">
                <label
                  class="check inline permission-option"
                  *ngFor="let permission of permissionsCatalog; trackBy: trackPermissionCatalog"
                  [title]="permission.description || permission.code"
                >
                  <input
                    type="checkbox"
                    [checked]="isSelectedRolePermission(permission.code)"
                    [disabled]="isSelectedAdminProfile()"
                    (change)="setSelectedRolePermission(permission.code, $any($event.target).checked)"
                  />
                  <span class="permission-option__text">
                    <span class="permission-option__label">{{ permission.label || permission.code }}</span>
                    <span class="permission-option__code">{{ permission.code }}</span>
                  </span>
                </label>
              </div>
            </div>

            <div class="permission-block">
              <div class="card-head">
                <strong>Pastas e relatórios</strong>
                <div class="table-actions">
                  <app-button size="sm" tone="neutral" variant="outline" (pressed)="expandAllRoleAclFolders()">Expandir tudo</app-button>
                  <app-button size="sm" tone="neutral" variant="outline" (pressed)="collapseAllRoleAclFolders()">Recolher tudo</app-button>
                  <app-button
                    size="sm"
                    tone="primary"
                    variant="solid"
                    [disabled]="aclTreeSaving || aclTreeLoading || isSelectedAdminProfile()"
                    (pressed)="saveRoleAclTree()"
                  >
                    {{ aclTreeSaving ? 'Salvando ACL...' : 'Salvar ACL do perfil' }}
                  </app-button>
                </div>
              </div>
              <label class="field acl-search-field">
                <span>Buscar pasta ou relatório</span>
                <input
                  type="text"
                  [(ngModel)]="roleAclSearchTerm"
                  [ngModelOptions]="{ standalone: true }"
                  placeholder="Digite para filtrar"
                />
              </label>
              <div class="acl-filter-actions">
                <app-button
                  size="sm"
                  [tone]="roleAclAccessFilter === 'ALLOW' ? 'primary' : 'neutral'"
                  [variant]="roleAclAccessFilter === 'ALLOW' ? 'solid' : 'outline'"
                  (pressed)="toggleRoleAclAccessFilter('ALLOW')"
                >
                  Com acesso
                </app-button>
                <app-button
                  size="sm"
                  [tone]="roleAclAccessFilter === 'DENY' ? 'danger' : 'neutral'"
                  [variant]="roleAclAccessFilter === 'DENY' ? 'solid' : 'outline'"
                  (pressed)="toggleRoleAclAccessFilter('DENY')"
                >
                  Sem acesso
                </app-button>
              </div>
              <div class="muted" *ngIf="aclTreeLoading">Carregando ACL do perfil...</div>
              <div class="acl-tree-editor" *ngIf="!aclTreeLoading">
                <div class="acl-tree-folder" *ngFor="let folderNode of filteredRoleAclTree(); trackBy: trackRoleAclFolder">
                  <button type="button" class="acl-tree-folder-head" (click)="toggleRoleAclFolder(folderNode.id)">
                    <span>{{ folderNode.expanded ? '▾' : '▸' }}</span>
                    <span class="acl-kind-chip acl-kind-chip--folder">PASTA</span>
                    <strong>{{ folderNode.name }}</strong>
                    <span class="perm-chip">{{ folderNode.reports.length }} relatório(s)</span>
                    <span class="perm-chip" [class.perm-chip--allowed]="folderNode.allowed" [class.perm-chip--denied]="!folderNode.allowed">
                      {{ folderNode.allowed ? 'Com acesso' : 'Sem acesso' }}
                    </span>
                    <span class="perm-chip">
                      {{ allowedReportsCount(folderNode) }} com acesso
                    </span>
                  </button>

                  <div class="acl-tree-folder-body" *ngIf="folderNode.expanded">
                    <div class="acl-entity-title">Permissões da pasta</div>
                    <label class="field acl-simple-field">
                      <span>Permissão da pasta</span>
                      <select
                        [ngModel]="folderNode.allowed ? 'ALLOW' : 'DENY'"
                        [ngModelOptions]="{ standalone: true }"
                        [disabled]="isSelectedAdminProfile()"
                        (ngModelChange)="setFolderAclAllowed(folderNode.id, $event === 'ALLOW')"
                      >
                        <option value="ALLOW">Com acesso (ver e executar)</option>
                        <option value="DENY">Sem acesso</option>
                      </select>
                    </label>

                    <div class="acl-tree-report" *ngFor="let reportNode of folderNode.reports; trackBy: trackRoleAclReport">
                      <div class="acl-tree-report-head">
                        <div class="acl-tree-report-title">
                          <span class="acl-kind-chip acl-kind-chip--report">RELATÓRIO</span>
                          {{ reportNode.name }}
                        </div>
                        <app-button
                          size="sm"
                          tone="neutral"
                          variant="outline"
                          [disabled]="reportNode.useFolderInheritance || isSelectedAdminProfile()"
                          (pressed)="inheritReportAclFromFolder(folderNode.id, reportNode.id)"
                        >
                          Herdar pasta
                        </app-button>
                      </div>
                      <div class="acl-entity-title acl-entity-title--sub">Permissões do relatório</div>
                      <label class="field acl-simple-field">
                        <span>Permissão do relatório</span>
                        <select
                          [ngModel]="reportNode.allowed ? 'ALLOW' : 'DENY'"
                          [ngModelOptions]="{ standalone: true }"
                          [disabled]="isSelectedAdminProfile()"
                          (ngModelChange)="setReportAclAllowed(folderNode.id, reportNode.id, $event === 'ALLOW')"
                        >
                          <option value="ALLOW">Com acesso (ver e executar)</option>
                          <option value="DENY">Sem acesso</option>
                        </select>
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>

          <div class="muted" *ngIf="!selectedRoleName">Crie um perfil ou selecione um perfil para editar permissões e ACL.</div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" *ngIf="createUserModalOpen" (click)="closeCreateUserModal()"></div>
  <div class="modal-card" *ngIf="createUserModalOpen">
    <div class="card-head">
      <h3>Criar usuário</h3>
      <app-button tone="neutral" variant="outline" (pressed)="closeCreateUserModal()">Fechar</app-button>
    </div>
    <div class="status-row modal-status-row">
      <div class="status error" *ngIf="error">{{ error }}</div>
      <div class="status ok" *ngIf="status">{{ status }}</div>
    </div>

    <div class="create-form">
      <label class="field">
        <span>Nome</span>
        <input type="text" [(ngModel)]="createForm.name" [ngModelOptions]="{ standalone: true }" placeholder="Nome completo" />
      </label>

      <label class="field">
        <span>E-mail</span>
        <input type="email" [(ngModel)]="createForm.email" [ngModelOptions]="{ standalone: true }" placeholder="usuario@empresa.com" />
      </label>

      <label class="field">
        <span>Senha</span>
        <input type="password" [(ngModel)]="createForm.password" [ngModelOptions]="{ standalone: true }" placeholder="Mínimo 6 caracteres" />
      </label>

      <label class="check">
        <input type="checkbox" [(ngModel)]="createForm.active" [ngModelOptions]="{ standalone: true }" />
        Ativo
      </label>

      <div class="roles-picker">
        <span class="roles-label">Perfis iniciais</span>
        <app-reports-multi-select
          [options]="createUserRoleOptions()"
          [selectedValues]="createUserSelectedRoles()"
          [placeholder]="'Selecione os perfis (obrigatório)'"
          (selectedValuesChange)="onCreateUserRolesChange($event)"
        ></app-reports-multi-select>
      </div>

      <app-button tone="primary" variant="solid" (pressed)="createUser()" [disabled]="saving || !canSubmitCreateUser()">
        {{ saving ? 'Criando...' : 'Criar usuário' }}
      </app-button>
    </div>
  </div>

  <div class="modal-backdrop" *ngIf="editUserModalOpen" (click)="closeEditUserModal()"></div>
  <div class="modal-card" *ngIf="editUserModalOpen && editUserDraft">
    <div class="card-head">
      <h3>Editar usuário</h3>
      <app-button tone="neutral" variant="outline" (pressed)="closeEditUserModal()">Fechar</app-button>
    </div>
    <div class="status-row modal-status-row">
      <div class="status error" *ngIf="error">{{ error }}</div>
      <div class="status ok" *ngIf="status">{{ status }}</div>
    </div>

    <div class="create-form">
      <label class="field">
        <span>Nome</span>
        <input type="text" [(ngModel)]="editUserDraft.name" [ngModelOptions]="{ standalone: true }" />
      </label>

      <label class="field">
        <span>E-mail</span>
        <input type="text" [value]="editUserDraft.email" disabled />
      </label>

      <label class="check">
        <input type="checkbox" [(ngModel)]="editUserDraft.active" [ngModelOptions]="{ standalone: true }" />
        Ativo
      </label>

      <div class="roles-picker">
        <span class="roles-label">Perfis</span>
        <app-reports-multi-select
          [options]="createUserRoleOptions()"
          [selectedValues]="editUserRoleSelection"
          [placeholder]="'Selecione os perfis'"
          (selectedValuesChange)="onEditUserRolesChange($event)"
        ></app-reports-multi-select>
      </div>

      <app-button tone="primary" variant="solid" (pressed)="saveEditUser()" [disabled]="editUserSaving">
        {{ editUserSaving ? 'Salvando...' : 'Salvar alterações' }}
      </app-button>
    </div>
  </div>

  <div class="modal-backdrop" *ngIf="passwordModalOpen" (click)="closePasswordModal()"></div>
  <div class="modal-card modal-card--sm" *ngIf="passwordModalOpen && passwordModalUser">
    <div class="card-head">
      <h3>Redefinir senha</h3>
      <app-button tone="neutral" variant="outline" (pressed)="closePasswordModal()">Fechar</app-button>
    </div>
    <div class="status-row modal-status-row">
      <div class="status error" *ngIf="error">{{ error }}</div>
      <div class="status ok" *ngIf="status">{{ status }}</div>
    </div>
    <div class="create-form">
      <div class="meta">{{ passwordModalUser.email }}</div>
      <label class="field">
        <span>Nova senha</span>
        <input
          type="password"
          [(ngModel)]="passwordModalValue"
          [ngModelOptions]="{ standalone: true }"
          placeholder="Mínimo 6 caracteres"
          autocomplete="new-password"
        />
      </label>
      <app-button tone="primary" variant="solid" (pressed)="submitPasswordReset()" [disabled]="passwordModalSaving">
        {{ passwordModalSaving ? 'Salvando...' : 'Redefinir senha' }}
      </app-button>
    </div>
  </div>
</section>
