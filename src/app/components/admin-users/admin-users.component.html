<section class="admin-shell">
  <div class="admin-grid">
    <div class="card card-header">
      <div class="card-head">
        <div>
          <h2>{{ adminSection === 'USERS' ? 'Usuários' : 'Permissões' }}</h2>
          <p class="muted">
            {{ adminSection === 'USERS'
              ? 'Gerencie criação, ativação e permissões de acesso.'
              : 'Gerencie perfis e regras ACL de pastas e relatórios.' }}
          </p>
        </div>
        <app-button *ngIf="adminSection === 'USERS'" tone="primary" variant="solid" (pressed)="openCreateUserModal()">
          Criar usuário
        </app-button>
      </div>
      <div class="status-row">
        <div class="status error" *ngIf="error && !anyModalOpen">{{ error }}</div>
        <div class="status ok" *ngIf="status && !anyModalOpen">{{ status }}</div>
      </div>
    </div>

    <div class="card card-users" *ngIf="adminSection === 'USERS'">
      <div class="card-head">
        <h3>Lista de usuários</h3>
        <div class="users-head-actions">
          <input
            type="text"
            [(ngModel)]="userSearchTerm"
            [ngModelOptions]="{ standalone: true }"
            placeholder="Filtrar por nome ou e-mail"
            aria-label="Filtrar usuários por nome ou e-mail"
          />
          <app-button tone="neutral" variant="outline" (pressed)="loadAll()" [disabled]="loading">
            {{ loading ? 'Atualizando...' : 'Atualizar' }}
          </app-button>
        </div>
      </div>

      <div class="users-toolbar">
        <div class="users-status-filters">
          <app-button size="sm" [tone]="userStatusFilter === 'ALL' ? 'primary' : 'neutral'" [variant]="userStatusFilter === 'ALL' ? 'solid' : 'outline'" (pressed)="userStatusFilter = 'ALL'">Todos ({{ userStatusCount('ALL') }})</app-button>
          <app-button size="sm" [tone]="userStatusFilter === 'ACTIVE' ? 'primary' : 'neutral'" [variant]="userStatusFilter === 'ACTIVE' ? 'solid' : 'outline'" (pressed)="userStatusFilter = 'ACTIVE'">Ativos ({{ userStatusCount('ACTIVE') }})</app-button>
          <app-button size="sm" [tone]="userStatusFilter === 'INACTIVE' ? 'danger' : 'neutral'" [variant]="userStatusFilter === 'INACTIVE' ? 'solid' : 'outline'" (pressed)="userStatusFilter = 'INACTIVE'">Inativos ({{ userStatusCount('INACTIVE') }})</app-button>
          <app-reports-multi-select
            class="users-profile-filter"
            [options]="userProfileFilterOptions()"
            [selectedValues]="userProfileFilters"
            [placeholder]="'Filtrar por perfil'"
            (selectedValuesChange)="onUserProfileFiltersChange($event)"
          ></app-reports-multi-select>
        </div>
        <small class="users-last-update" *ngIf="usersLastUpdatedAt">Atualizado: {{ usersLastUpdatedAt | date : 'dd/MM/yyyy HH:mm:ss' }}</small>
      </div>

      <div class="users-bulk-actions" [class.active]="selectedUsersCount() > 0" [attr.aria-hidden]="selectedUsersCount() > 0 ? null : true">
        <ng-container *ngIf="selectedUsersCount() > 0; else bulkEmpty">
          <span class="users-bulk-label">{{ selectedUsersCount() }} usuário(s) selecionado(s)</span>
          <div class="table-actions">
            <app-button size="sm" tone="neutral" variant="outline" [disabled]="bulkUsersLoading" (pressed)="setSelectedUsersActive(true)">
              Ativar
            </app-button>
            <app-button size="sm" tone="neutral" variant="outline" [disabled]="bulkUsersLoading" (pressed)="setSelectedUsersActive(false)">
              Desativar
            </app-button>
            <app-button size="sm" tone="neutral" variant="outline" [disabled]="bulkUsersLoading" (pressed)="revokeRefreshTokensBulk()">
              Revogar refresh
            </app-button>
            <select
              [(ngModel)]="bulkTargetRole"
              [ngModelOptions]="{ standalone: true }"
              [disabled]="bulkUsersLoading"
              aria-label="Selecionar perfil para alterar em lote"
            >
              <option value="">Aplicar perfil...</option>
              <option *ngFor="let role of roles" [value]="role.name">{{ role.name }}</option>
            </select>
            <app-button size="sm" tone="neutral" variant="outline" [disabled]="bulkUsersLoading || !bulkTargetRole" (pressed)="applyBulkRole()">
              Aplicar perfil
            </app-button>
            <app-button size="sm" tone="neutral" variant="outline" [disabled]="bulkUsersLoading" (pressed)="clearSelectedUsers()">
              Limpar seleção
            </app-button>
          </div>
        </ng-container>
        <ng-template #bulkEmpty>
          <span class="users-bulk-empty">Selecione usuários para ações em lote.</span>
        </ng-template>
      </div>

      <div class="users-table-wrap" (click)="closeUserRowMenu()">
        <div class="users-table-loading" *ngIf="loading || bulkUsersLoading">Atualizando usuários...</div>
        <table class="users-table">
          <thead>
            <tr>
              <th class="check-col">
                <input
                  type="checkbox"
                  [checked]="areAllFilteredUsersSelected()"
                  [indeterminate]="isPartialUsersSelection()"
                  (click)="$event.stopPropagation()"
                  (change)="toggleSelectAllFilteredUsers($any($event.target).checked)"
                  aria-label="Selecionar todos os usuários filtrados"
                />
              </th>
              <th>
                <button type="button" class="table-sort-btn" (click)="toggleUserSort('name')">
                  Nome {{ userSortIndicator('name') }}
                </button>
              </th>
              <th>
                <button type="button" class="table-sort-btn" (click)="toggleUserSort('email')">
                  E-mail {{ userSortIndicator('email') }}
                </button>
              </th>
              <th>
                <button type="button" class="table-sort-btn" (click)="toggleUserSort('status')">
                  Status {{ userSortIndicator('status') }}
                </button>
              </th>
              <th>Perfis</th>
              <th>
                <button type="button" class="table-sort-btn" (click)="toggleUserSort('createdAt')">
                  Criado {{ userSortIndicator('createdAt') }}
                </button>
              </th>
              <th>
                <button type="button" class="table-sort-btn" (click)="toggleUserSort('updatedAt')">
                  Atualizado {{ userSortIndicator('updatedAt') }}
                </button>
              </th>
              <th class="actions-col">Ações</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of filteredUsers(); trackBy: trackUser">
              <td class="check-col">
                <input
                  type="checkbox"
                  [checked]="isUserSelected(user.id)"
                  (click)="$event.stopPropagation()"
                  (change)="toggleUserSelection(user.id, $any($event.target).checked)"
                  [attr.aria-label]="'Selecionar usuário ' + user.email"
                />
              </td>
              <td>
                <div class="user-name">{{ user.name || '-' }} <span class="user-self-chip" *ngIf="isCurrentUser(user)">(você)</span></div>
              </td>
              <td>
                <div class="user-email">{{ user.email }}</div>
                <div class="meta user-id">ID: {{ user.id }}</div>
              </td>
              <td>
                <span class="status-chip" [class.inactive]="!user.active">
                  {{ user.active ? 'Ativo' : 'Inativo' }}
                </span>
              </td>
              <td>
                <div class="roles-inline">
                  <span class="role-chip" *ngFor="let role of user.roles">{{ role }}</span>
                </div>
              </td>
              <td>{{ user.createdAt | date : 'dd/MM/yyyy HH:mm' }}</td>
              <td>{{ user.updatedAt | date : 'dd/MM/yyyy HH:mm' }}</td>
              <td class="actions-col">
                <div class="table-actions">
                  <app-button size="sm" tone="neutral" variant="outline" (pressed)="openEditUserModal(user)">Editar</app-button>
                  <button type="button" class="row-menu-trigger" (click)="$event.stopPropagation(); toggleUserRowMenu(user.id)">⋯</button>
                  <div class="row-menu" *ngIf="isUserRowMenuOpen(user.id)" (click)="$event.stopPropagation()">
                    <button type="button" (click)="openPasswordModal(user)">Redefinir senha</button>
                    <button type="button" (click)="revokeRefreshTokens(user)">Revogar refresh</button>
                    <button type="button" *ngIf="!user.active" (click)="setUserActiveQuick(user, true)">Ativar usuário</button>
                    <button type="button" *ngIf="user.active" (click)="setUserActiveQuick(user, false)">Desativar usuário</button>
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <app-admin-users-permissions-acl
      *ngIf="adminSection === 'PERMISSIONS'"
      (errorChange)="error = $event"
      (statusChange)="status = $event"
    ></app-admin-users-permissions-acl>
  </div>

  <div class="modal-backdrop" *ngIf="createUserModalOpen" (click)="closeCreateUserModal()"></div>
  <div class="modal-card" *ngIf="createUserModalOpen">
    <div class="card-head">
      <h3>Criar usuário</h3>
      <app-button tone="neutral" variant="outline" (pressed)="closeCreateUserModal()">Fechar</app-button>
    </div>
    <div class="status-row modal-status-row">
      <div class="status error" *ngIf="error">{{ error }}</div>
      <div class="status ok" *ngIf="status">{{ status }}</div>
    </div>

    <div class="create-form">
      <label class="field">
        <span>Nome</span>
        <input type="text" [(ngModel)]="createForm.name" [ngModelOptions]="{ standalone: true }" placeholder="Nome completo" />
      </label>

      <label class="field">
        <span>E-mail</span>
        <input type="email" [(ngModel)]="createForm.email" [ngModelOptions]="{ standalone: true }" placeholder="usuario@empresa.com" />
      </label>

      <label class="field">
        <span>Senha</span>
        <input
          type="password"
          [(ngModel)]="createForm.password"
          [ngModelOptions]="{ standalone: true }"
          placeholder="Mínimo 10 caracteres, com maiúscula, minúscula, número e especial"
          autocomplete="new-password"
        />
        <small class="field-help">{{ passwordRuleMessage }}</small>
      </label>

      <label class="check">
        <input type="checkbox" [(ngModel)]="createForm.active" [ngModelOptions]="{ standalone: true }" />
        Ativo
      </label>

      <div class="roles-picker">
        <span class="roles-label">Perfis iniciais</span>
        <app-reports-multi-select
          [options]="createUserRoleOptions()"
          [selectedValues]="createUserSelectedRoles()"
          [placeholder]="'Selecione os perfis (obrigatório)'"
          (selectedValuesChange)="onCreateUserRolesChange($event)"
        ></app-reports-multi-select>
      </div>

      <app-button tone="primary" variant="solid" (pressed)="createUser()" [disabled]="saving || !canSubmitCreateUser()">
        {{ saving ? 'Criando...' : 'Criar usuário' }}
      </app-button>
    </div>
  </div>

  <div class="modal-backdrop" *ngIf="editUserModalOpen" (click)="closeEditUserModal()"></div>
  <div class="modal-card" *ngIf="editUserModalOpen && editUserDraft">
    <div class="card-head">
      <h3>Editar usuário</h3>
      <app-button tone="neutral" variant="outline" (pressed)="closeEditUserModal()">Fechar</app-button>
    </div>
    <div class="status-row modal-status-row">
      <div class="status error" *ngIf="error">{{ error }}</div>
      <div class="status ok" *ngIf="status">{{ status }}</div>
    </div>

    <div class="create-form">
      <label class="field">
        <span>Nome</span>
        <input type="text" [(ngModel)]="editUserDraft.name" [ngModelOptions]="{ standalone: true }" />
      </label>

      <label class="field">
        <span>E-mail</span>
        <input type="text" [value]="editUserDraft.email" disabled />
      </label>

      <label class="check">
        <input type="checkbox" [(ngModel)]="editUserDraft.active" [ngModelOptions]="{ standalone: true }" />
        Ativo
      </label>

      <div class="roles-picker">
        <span class="roles-label">Perfis</span>
        <app-reports-multi-select
          [options]="createUserRoleOptions()"
          [selectedValues]="editUserRoleSelection"
          [placeholder]="'Selecione os perfis'"
          (selectedValuesChange)="onEditUserRolesChange($event)"
        ></app-reports-multi-select>
      </div>

      <app-button tone="primary" variant="solid" (pressed)="saveEditUser()" [disabled]="editUserSaving">
        {{ editUserSaving ? 'Salvando...' : 'Salvar alterações' }}
      </app-button>
    </div>
  </div>

  <div class="modal-backdrop" *ngIf="passwordModalOpen" (click)="closePasswordModal()"></div>
  <div class="modal-card modal-card--sm" *ngIf="passwordModalOpen && passwordModalUser">
    <div class="card-head">
      <h3>Redefinir senha</h3>
      <app-button tone="neutral" variant="outline" (pressed)="closePasswordModal()">Fechar</app-button>
    </div>
    <div class="status-row modal-status-row">
      <div class="status error" *ngIf="error">{{ error }}</div>
      <div class="status ok" *ngIf="status">{{ status }}</div>
    </div>
    <div class="create-form">
      <div class="meta">{{ passwordModalUser.email }}</div>
      <label class="field">
        <span>Nova senha</span>
        <input
          type="password"
          [(ngModel)]="passwordModalValue"
          [ngModelOptions]="{ standalone: true }"
          placeholder="Mínimo 10 caracteres, com maiúscula, minúscula, número e especial"
          autocomplete="new-password"
        />
        <small class="field-help">{{ passwordRuleMessage }}</small>
      </label>
      <app-button
        tone="primary"
        variant="solid"
        (pressed)="submitPasswordReset()"
        [disabled]="passwordModalSaving || !isPasswordStrong(passwordModalValue)"
      >
        {{ passwordModalSaving ? 'Salvando...' : 'Redefinir senha' }}
      </app-button>
    </div>
  </div>
</section>
