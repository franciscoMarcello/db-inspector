<dialog #dlg class="modal">
  <div class="wrap" (click)="$event.stopPropagation()">
    <h3>Ambientes</h3>

    <div class="list" *ngIf="list().length; else empty">
      <div class="row" *ngFor="let env of list()">
        <div class="meta">
          <div class="name">
            {{ env.name }}
            <span class="badge" *ngIf="env.id === activeId()">ativo</span>
          </div>
          <div class="url">{{ env.url }}</div>
        </div>

        <div class="actions">
          <button
            *ngIf="env.id !== activeId()"
            type="button"
            class="btn btn--primary btn--sm"
            (click)="setActive(env)"
          >
            <svg class="btn__icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M9 16.2l-3.5-3.5-1.4 1.4L9 19 20 8l-1.4-1.4z" />
            </svg>
            Ativar
          </button>

          <button type="button" class="btn btn--outline-primary btn--sm" (click)="startEdit(env)">
            <svg class="btn__icon" viewBox="0 0 24 24" aria-hidden="true">
              <path
                d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zm14.71-9.04a1 1 0 000-1.41l-2.5-2.5a1 1 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.99-1.67z"
              />
            </svg>
            Editar
          </button>

          <button type="button" class="btn btn--danger btn--sm" (click)="remove(env)">
            <svg class="btn__icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M6 7h12v2H6V7zm2 3h8l-1 9H9L8 10zm3-6h2l1 2H10l1-2z" />
            </svg>
            Excluir
          </button>
        </div>
      </div>
    </div>
    <ng-template #empty>
      <p>Nenhum ambiente salvo ainda.</p>
    </ng-template>

    <hr />

    <form class="form" [formGroup]="form" (ngSubmit)="save()">
      <h4>{{ editing ? 'Editar ambiente' : 'Novo ambiente' }}</h4>

      <div class="tabs">
        <button type="button" class="tab" [class.active]="activeTab === 'api'" (click)="setTab('api')">
          Dados da API
        </button>
        <button type="button" class="tab" [class.active]="activeTab === 'db'" (click)="setTab('db')">
          Banco de dados
        </button>
      </div>

      <div *ngIf="activeTab === 'api'" class="tab-panel">
        <label class="field">
          <span>Nome</span>
          <input formControlName="name" />
          <small *ngIf="form.controls.name.touched && form.controls.name.invalid">
            Mínimo 2 caracteres
          </small>
        </label>

        <label class="field">
          <span>URL</span>
          <input formControlName="url" placeholder="https://api.exemplo.com" />
          <small *ngIf="form.controls.url.touched && form.controls.url.invalid">URL inválida</small>
        </label>

        <label class="field">
          <span>API Key</span>
          <input type="password" formControlName="apiKey" />
          <small *ngIf="form.controls.apiKey.touched && form.controls.apiKey.invalid"
            >Obrigatório</small
          >
        </label>

        <label class="field">
          <span>Backend</span>
          <input formControlName="backend" placeholder="http://localhost:8080/api/db" />
          <small *ngIf="form.controls.backend.touched && form.controls.backend.invalid">
            URL do backend inválida (ex.: http://localhost:8080/api/db)
          </small>
        </label>
      </div>

      <div *ngIf="activeTab === 'db'" class="tab-panel">
        <h5>Banco de dados (Postgres)</h5>

        <div class="grid">
          <label class="field">
            <span>Host</span>
            <input formControlName="dbHost" placeholder="localhost" />
            <small class="hint">Opcional — se vazio, usar host padrão.</small>
          </label>

          <label class="field">
            <span>Porta</span>
            <input type="number" formControlName="dbPort" placeholder="5432" />
            <small class="hint">Opcional — default 5432.</small>
          </label>
        </div>

        <div class="grid">
          <label class="field">
            <span>Database</span>
            <input formControlName="dbName" placeholder="meu_banco" />
            <small class="hint">Opcional.</small>
          </label>

          <label class="field">
            <span>Schema</span>
            <input formControlName="dbSchema" placeholder="public" />
            <small class="hint">Opcional — default public.</small>
          </label>
        </div>

        <div class="grid">
          <label class="field">
            <span>Usuário</span>
            <input formControlName="dbUser" placeholder="postgres" />
            <small class="hint">Opcional.</small>
          </label>

          <label class="field">
            <span>Senha</span>
            <input type="password" formControlName="dbPassword" placeholder="••••••" />
            <small class="hint">Opcional.</small>
          </label>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn--outline-neutral" (click)="startAdd()">
          <svg class="btn__icon" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2h6z" />
          </svg>
          Novo
        </button>

        <button type="submit" class="btn btn--primary" [disabled]="form.invalid">
          <svg class="btn__icon" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M17 3H7a2 2 0 00-2 2v14l7-3 7 3V5a2 2 0 00-2-2z" />
          </svg>
          {{ editing ? 'Salvar' : 'Adicionar' }}
        </button>

        <button type="button" class="btn btn--secondary" (click)="close()">
          <svg class="btn__icon" viewBox="0 0 24 24" aria-hidden="true">
            <path
              d="M18.3 5.71L12 12l6.3 6.29-1.41 1.42L10.59 13.4 4.3 19.71 2.89 18.3 9.17 12 2.89 5.71 4.3 4.29l6.29 6.3 6.29-6.3z"
            />
          </svg>
          Fechar
        </button>
      </div>
    </form>
  </div>
</dialog>
